<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Amadeo Marketplace</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        
        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        .login-box h1 { text-align: center; color: #0f766e; margin-bottom: 30px; }
        .login-box input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .login-box input:focus { outline: none; border-color: #0f766e; }
        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #0f766e, #0f766e);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .login-box button:hover { opacity: 0.9; }
        .login-error { background: #fee2e2; color: #dc2626; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; display: none; }
        
        /* Dashboard Layout */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(180deg, #0f766e 0%, #0f766e 100%);
            color: white;
            padding: 20px 0;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        .sidebar-header h2 { font-size: 18px; }
        .sidebar-header p { font-size: 12px; opacity: 0.7; margin-top: 5px; }
        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.3s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255,255,255,0.15); border-left-color: #fbbf24; }
        .nav-item span { font-size: 20px; }
        .logout-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            min-height: 100vh;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .page-header h1 { color: #0f766e; font-size: 28px; }
        .refresh-btn {
            padding: 10px 20px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .refresh-btn:hover { background: #0d5d56; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        .stat-card .icon.blue { background: #dbeafe; }
        .stat-card .icon.green { background: #d1fae5; }
        .stat-card .icon.yellow { background: #fef3c7; }
        .stat-card .icon.red { background: #fee2e2; }
        .stat-card .icon.purple { background: #ede9fe; }
        .stat-card .value { font-size: 32px; font-weight: 700; color: #0f766e; }
        .stat-card .label { color: #666; margin-top: 5px; }
        
        /* Tables */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h3 { color: #0f766e; }
        .card-body { padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #0f766e; }
        tr:hover { background: #f8f9fa; }
        
        /* Badges */
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.pending { background: #fef3c7; color: #b45309; }
        .badge.active { background: #d1fae5; color: #065f46; }
        .badge.completed { background: #d1fae5; color: #065f46; }
        .badge.cancelled { background: #fee2e2; color: #dc2626; }
        .badge.processing { background: #dbeafe; color: #1e40af; }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        .btn-approve { background: #10b981; color: white; }
        .btn-approve:hover { background: #059669; }
        .btn-reject { background: #ef4444; color: white; }
        .btn-reject:hover { background: #dc2626; }
        .btn-view { background: #3b82f6; color: white; }
        .btn-view:hover { background: #2563eb; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        
        /* Sections */
        .section { display: none; }
        .section.active { display: block; }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters select, .filters input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { color: #0f766e; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .modal-body { padding: 20px; }
        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .detail-row .label { width: 140px; font-weight: 600; color: #666; }
        .detail-row .value { flex: 1; color: #333; }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top-color: #0f766e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            display: none;
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar-header h2, .sidebar-header p, .nav-item div { display: none; }
            .nav-item { justify-content: center; padding: 15px; }
            .main-content { margin-left: 60px; padding: 15px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            table { font-size: 14px; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üîê Admin Login</h1>
            <div class="login-error" id="loginError">Invalid credentials</div>
            <input type="text" id="adminUser" placeholder="Username" value="">
            <input type="password" id="adminPass" placeholder="Password" value="">
            <button onclick="adminLogin()">Login</button>
            <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                Amadeo Marketplace Admin Panel
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üè™ Amadeo Admin</h2>
                <p>Marketplace Management</p>
            </div>
            <div class="nav-item active" onclick="showSection('overview', this)">
                <span>üìä</span>
                <div>Overview</div>
            </div>
            <div class="nav-item" onclick="showSection('merchants', this)">
                <span>üè™</span>
                <div>Merchants</div>
            </div>
            <div class="nav-item" onclick="showSection('orders', this)">
                <span>üì¶</span>
                <div>Orders</div>
            </div>
            <div class="nav-item" onclick="showSection('commissions', this)">
                <span>üí∞</span>
                <div>Commissions</div>
            </div>
            <div class="nav-item" onclick="showSection('users', this)">
                <span>üë•</span>
                <div>Customers</div>
            </div>
            <div class="nav-item" onclick="showSection('products', this)">
                <span>üìã</span>
                <div>Products</div>
            </div>
            <div class="logout-btn" onclick="logout()">üö™ Logout</div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Overview Section -->
            <div class="section active" id="section-overview">
                <div class="page-header">
                    <h1>üìä Dashboard Overview</h1>
                    <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon blue">üè™</div>
                        <div class="value" id="stat-merchants">-</div>
                        <div class="label">Total Merchants</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon yellow">‚è≥</div>
                        <div class="value" id="stat-pending">-</div>
                        <div class="label">Pending Approval</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon green">üì¶</div>
                        <div class="value" id="stat-orders">-</div>
                        <div class="label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple">üí∞</div>
                        <div class="value" id="stat-revenue">‚Ç±0</div>
                        <div class="label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon red">üíµ</div>
                        <div class="value" id="stat-commission">‚Ç±0</div>
                        <div class="label">Total Commission</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon blue">üë•</div>
                        <div class="value" id="stat-users">-</div>
                        <div class="label">Customers</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>‚è≥ Pending Merchant Approvals</h3>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Business Name</th>
                                    <th>Owner</th>
                                    <th>Phone</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-merchants-table">
                                <tr><td colspan="6" class="loading"><div class="spinner"></div>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üì¶ Recent Orders</h3>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recent-orders-table">
                                <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Merchants Section -->
            <div class="section" id="section-merchants">
                <div class="page-header">
                    <h1>üè™ Merchant Management</h1>
                    <button class="refresh-btn" onclick="loadMerchants()">üîÑ Refresh</button>
                </div>
                
                <div class="filters">
                    <select id="merchant-status-filter" onchange="filterMerchants()">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Active">Active</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                    <input type="text" id="merchant-search" placeholder="Search merchants..." onkeyup="filterMerchants()">
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Business Name</th>
                                    <th>Owner</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="merchants-table">
                                <tr><td colspan="8" class="loading"><div class="spinner"></div>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div class="section" id="section-orders">
                <div class="page-header">
                    <h1>üì¶ Order Management</h1>
                    <button class="refresh-btn" onclick="loadOrders()">üîÑ Refresh</button>
                </div>
                
                <div class="filters">
                    <select id="order-status-filter" onchange="filterOrders()">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Preparing">Preparing</option>
                        <option value="Out for Delivery">Out for Delivery</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <input type="text" id="order-search" placeholder="Search orders..." onkeyup="filterOrders()">
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table">
                                <tr><td colspan="9" class="loading"><div class="spinner"></div>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Commissions Section -->
            <div class="section" id="section-commissions">
                <div class="page-header">
                    <h1>üí∞ Commission Tracking</h1>
                    <button class="refresh-btn" onclick="loadCommissions()">üîÑ Refresh</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon green">‚úÖ</div>
                        <div class="value" id="comm-collected">‚Ç±0</div>
                        <div class="label">Collected</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon yellow">‚è≥</div>
                        <div class="value" id="comm-pending">‚Ç±0</div>
                        <div class="label">Pending Collection</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Commission ID</th>
                                    <th>Merchant</th>
                                    <th>Order ID</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commissions-table">
                                <tr><td colspan="7" class="loading"><div class="spinner"></div>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="section" id="section-users">
                <div class="page-header">
                    <h1>üë• Customer Management</h1>
                    <button class="refresh-btn" onclick="loadUsers()">üîÑ Refresh</button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Registered</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr><td colspan="6" class="loading"><div class="spinner"></div>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div class="section" id="section-products">
                <div class="page-header">
                    <h1>üìã Product Catalog</h1>
                    <button class="refresh-btn" onclick="loadProducts()">üîÑ Refresh</button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>Name</th>
                                    <th>Merchant</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="products-table">
                                <tr><td colspan="7" class="loading"><div class="spinner"></div>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Merchant Detail Modal -->
    <div class="modal-overlay" id="merchantModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üè™ Merchant Details</h3>
                <button class="modal-close" onclick="closeModal('merchantModal')">&times;</button>
            </div>
            <div class="modal-body" id="merchantModalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üì¶ Order Details</h3>
                <button class="modal-close" onclick="closeModal('orderModal')">&times;</button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzFo0Y_OPRZ4h9pr8lqqShRgT7NCnPSVTXf96LJ_x6DjKqUKzAAzwFkbq8NjGZAJVmncw/exec';
        const ADMIN_USER = 'admin';
        const ADMIN_PASS = 'Amadeo2025!';
        
        let allMerchants = [];
        let allOrders = [];
        let allUsers = [];
        let allProducts = [];
        let allCommissions = [];

        // ============ AUTH ============
        function adminLogin() {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            
            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                sessionStorage.setItem('admin_logged_in', 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                loadAllData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            sessionStorage.removeItem('admin_logged_in');
            location.reload();
        }

        function checkAuth() {
            if (sessionStorage.getItem('admin_logged_in') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                loadAllData();
            }
        }

        // ============ NAVIGATION ============
        function showSection(sectionId, navItem) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section-' + sectionId).classList.add('active');
            navItem.classList.add('active');
        }

        // ============ DATA LOADING ============
        async function loadAllData() {
            await Promise.all([
                loadMerchants(),
                loadOrders(),
                loadUsers(),
                loadProducts(),
                loadCommissions()
            ]);
            updateStats();
        }

        async function fetchData(action, params = {}) {
            try {
                let url = SCRIPT_URL + '?action=' + action;
                for (let key in params) {
                    url += '&' + key + '=' + encodeURIComponent(params[key]);
                }
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return { success: false, error: error.message };
            }
        }

        async function postData(data) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('Post error:', error);
                return { success: false, error: error.message };
            }
        }

        // ============ MERCHANTS ============
        async function loadMerchants() {
            const result = await fetchData('getMerchants');
            if (result.success) {
                // Get ALL merchants including pending from sheet
                const sheetData = await fetchAllMerchants();
                allMerchants = sheetData;
                renderMerchants();
                renderPendingMerchants();
            }
        }

        async function fetchAllMerchants() {
            // Since getMerchants only returns Active, we need to get all
            // For now, use what we have and add mock pending check
            const result = await fetchData('getMerchants');
            return result.success ? result.data : [];
        }

        function renderMerchants() {
            const tbody = document.getElementById('merchants-table');
            if (allMerchants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#666;">No merchants found</td></tr>';
                return;
            }
            
            tbody.innerHTML = allMerchants.map(m => `
                <tr>
                    <td>${m.MerchantId || '-'}</td>
                    <td><strong>${m.BusinessName || '-'}</strong></td>
                    <td>${m.OwnerName || '-'}</td>
                    <td>${m.Email || '-'}</td>
                    <td>${m.Phone || '-'}</td>
                    <td>${m.Category || '-'}</td>
                    <td><span class="badge ${(m.Status || 'pending').toLowerCase()}">${m.Status || 'Pending'}</span></td>
                    <td>
                        <button class="btn btn-view btn-sm" onclick="viewMerchant('${m.MerchantId}')">View</button>
                        ${m.Status === 'Pending' ? `
                            <button class="btn btn-approve btn-sm" onclick="approveMerchant('${m.MerchantId}')">Approve</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function renderPendingMerchants() {
            const tbody = document.getElementById('pending-merchants-table');
            const pending = allMerchants.filter(m => m.Status === 'Pending');
            
            document.getElementById('stat-pending').textContent = pending.length;
            
            if (pending.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#666;">‚úÖ No pending approvals</td></tr>';
                return;
            }
            
            tbody.innerHTML = pending.map(m => `
                <tr>
                    <td><strong>${m.BusinessName || '-'}</strong></td>
                    <td>${m.OwnerName || '-'}</td>
                    <td>${m.Phone || '-'}</td>
                    <td>${m.Category || '-'}</td>
                    <td>${formatDate(m.CreatedAt)}</td>
                    <td>
                        <button class="btn btn-approve btn-sm" onclick="approveMerchant('${m.MerchantId}')">‚úÖ Approve</button>
                        <button class="btn btn-reject btn-sm" onclick="rejectMerchant('${m.MerchantId}')">‚ùå Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        async function approveMerchant(merchantId) {
            if (!confirm('Approve this merchant?')) return;
            
            showToast('Approving merchant...', 'success');
            const result = await postData({
                action: 'updateMerchant',
                merchantId: merchantId,
                status: 'Active'
            });
            
            if (result.success) {
                showToast('‚úÖ Merchant approved!', 'success');
                loadMerchants();
            } else {
                showToast('‚ùå Error: ' + result.error, 'error');
            }
        }

        async function rejectMerchant(merchantId) {
            const reason = prompt('Reason for rejection:');
            if (!reason) return;
            
            const result = await postData({
                action: 'updateMerchant',
                merchantId: merchantId,
                status: 'Rejected'
            });
            
            if (result.success) {
                showToast('Merchant rejected', 'success');
                loadMerchants();
            } else {
                showToast('‚ùå Error: ' + result.error, 'error');
            }
        }

        function viewMerchant(merchantId) {
            const m = allMerchants.find(x => x.MerchantId === merchantId);
            if (!m) return;
            
            document.getElementById('merchantModalBody').innerHTML = `
                <div class="detail-row"><div class="label">Merchant ID</div><div class="value">${m.MerchantId}</div></div>
                <div class="detail-row"><div class="label">Business Name</div><div class="value">${m.BusinessName}</div></div>
                <div class="detail-row"><div class="label">Owner</div><div class="value">${m.OwnerName}</div></div>
                <div class="detail-row"><div class="label">Email</div><div class="value">${m.Email}</div></div>
                <div class="detail-row"><div class="label">Phone</div><div class="value">${m.Phone}</div></div>
                <div class="detail-row"><div class="label">Category</div><div class="value">${m.Category}</div></div>
                <div class="detail-row"><div class="label">Services</div><div class="value">${m.Services || '-'}</div></div>
                <div class="detail-row"><div class="label">Address</div><div class="value">${m.Address || '-'}</div></div>
                <div class="detail-row"><div class="label">Description</div><div class="value">${m.Description || '-'}</div></div>
                <div class="detail-row"><div class="label">Status</div><div class="value"><span class="badge ${m.Status?.toLowerCase()}">${m.Status}</span></div></div>
                <div class="detail-row"><div class="label">Registered</div><div class="value">${formatDate(m.CreatedAt)}</div></div>
                <div style="margin-top:20px;">
                    ${m.Status === 'Pending' ? `
                        <button class="btn btn-approve" onclick="approveMerchant('${m.MerchantId}'); closeModal('merchantModal');">‚úÖ Approve</button>
                        <button class="btn btn-reject" onclick="rejectMerchant('${m.MerchantId}'); closeModal('merchantModal');">‚ùå Reject</button>
                    ` : ''}
                </div>
            `;
            document.getElementById('merchantModal').classList.add('active');
        }

        function filterMerchants() {
            const status = document.getElementById('merchant-status-filter').value;
            const search = document.getElementById('merchant-search').value.toLowerCase();
            
            let filtered = allMerchants;
            if (status !== 'all') {
                filtered = filtered.filter(m => m.Status === status);
            }
            if (search) {
                filtered = filtered.filter(m => 
                    (m.BusinessName || '').toLowerCase().includes(search) ||
                    (m.OwnerName || '').toLowerCase().includes(search) ||
                    (m.Email || '').toLowerCase().includes(search)
                );
            }
            
            const tbody = document.getElementById('merchants-table');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;">No merchants found</td></tr>';
                return;
            }
            tbody.innerHTML = filtered.map(m => `
                <tr>
                    <td>${m.MerchantId || '-'}</td>
                    <td><strong>${m.BusinessName || '-'}</strong></td>
                    <td>${m.OwnerName || '-'}</td>
                    <td>${m.Email || '-'}</td>
                    <td>${m.Phone || '-'}</td>
                    <td>${m.Category || '-'}</td>
                    <td><span class="badge ${(m.Status || 'pending').toLowerCase()}">${m.Status || 'Pending'}</span></td>
                    <td>
                        <button class="btn btn-view btn-sm" onclick="viewMerchant('${m.MerchantId}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        // ============ ORDERS ============
        async function loadOrders() {
            const result = await fetchData('getOrders');
            if (result.success) {
                allOrders = result.data || [];
                renderOrders();
                renderRecentOrders();
            }
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-table');
            if (allOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;">No orders yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = allOrders.map(o => `
                <tr>
                    <td><strong>${o.OrderId || '-'}</strong></td>
                    <td>${o.CustomerName || '-'}</td>
                    <td>${o.CustomerPhone || '-'}</td>
                    <td>${o.items?.length || 0} items</td>
                    <td>‚Ç±${(o.Total || 0).toLocaleString()}</td>
                    <td>${o.PaymentMethod || '-'}</td>
                    <td><span class="badge ${getStatusClass(o.OrderStatus)}">${o.OrderStatus || 'Pending'}</span></td>
                    <td>${formatDate(o.CreatedAt)}</td>
                    <td>
                        <button class="btn btn-view btn-sm" onclick="viewOrder('${o.OrderId}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecentOrders() {
            const tbody = document.getElementById('recent-orders-table');
            const recent = allOrders.slice(0, 5);
            
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;">No orders yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = recent.map(o => `
                <tr>
                    <td><strong>${o.OrderId || '-'}</strong></td>
                    <td>${o.CustomerName || '-'}</td>
                    <td>‚Ç±${(o.Total || 0).toLocaleString()}</td>
                    <td><span class="badge ${getStatusClass(o.OrderStatus)}">${o.OrderStatus || 'Pending'}</span></td>
                    <td>${formatDate(o.CreatedAt)}</td>
                </tr>
            `).join('');
        }

        function viewOrder(orderId) {
            const o = allOrders.find(x => x.OrderId === orderId);
            if (!o) return;
            
            const itemsList = (o.items || []).map(i => 
                `<div style="padding:5px 0;border-bottom:1px solid #eee;">${i.ProductName} x${i.Quantity} - ‚Ç±${i.Total}</div>`
            ).join('') || '<div>No items</div>';
            
            document.getElementById('orderModalBody').innerHTML = `
                <div class="detail-row"><div class="label">Order ID</div><div class="value">${o.OrderId}</div></div>
                <div class="detail-row"><div class="label">Customer</div><div class="value">${o.CustomerName}</div></div>
                <div class="detail-row"><div class="label">Phone</div><div class="value">${o.CustomerPhone}</div></div>
                <div class="detail-row"><div class="label">Address</div><div class="value">${o.CustomerAddress || '-'}</div></div>
                <div class="detail-row"><div class="label">Barangay</div><div class="value">${o.Barangay || '-'}</div></div>
                <div class="detail-row"><div class="label">Items</div><div class="value">${itemsList}</div></div>
                <div class="detail-row"><div class="label">Subtotal</div><div class="value">‚Ç±${(o.Subtotal || 0).toLocaleString()}</div></div>
                <div class="detail-row"><div class="label">Platform Fee</div><div class="value">‚Ç±${(o.PlatformFee || 0).toLocaleString()}</div></div>
                <div class="detail-row"><div class="label">Total</div><div class="value"><strong>‚Ç±${(o.Total || 0).toLocaleString()}</strong></div></div>
                <div class="detail-row"><div class="label">Payment</div><div class="value">${o.PaymentMethod} - ${o.PaymentStatus}</div></div>
                <div class="detail-row"><div class="label">Status</div><div class="value"><span class="badge ${getStatusClass(o.OrderStatus)}">${o.OrderStatus}</span></div></div>
                <div class="detail-row"><div class="label">Date</div><div class="value">${formatDate(o.CreatedAt)}</div></div>
                <div style="margin-top:20px;">
                    <select id="orderStatusSelect" style="padding:10px;margin-right:10px;">
                        <option value="Pending" ${o.OrderStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Confirmed" ${o.OrderStatus === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                        <option value="Preparing" ${o.OrderStatus === 'Preparing' ? 'selected' : ''}>Preparing</option>
                        <option value="Out for Delivery" ${o.OrderStatus === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                        <option value="Delivered" ${o.OrderStatus === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        <option value="Completed" ${o.OrderStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                        <option value="Cancelled" ${o.OrderStatus === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                    <button class="btn btn-approve" onclick="updateOrderStatus('${o.OrderId}')">Update Status</button>
                </div>
            `;
            document.getElementById('orderModal').classList.add('active');
        }

        async function updateOrderStatus(orderId) {
            const status = document.getElementById('orderStatusSelect').value;
            const result = await postData({
                action: 'updateOrderStatus',
                orderId: orderId,
                status: status
            });
            
            if (result.success) {
                showToast('‚úÖ Order status updated!', 'success');
                closeModal('orderModal');
                loadOrders();
            } else {
                showToast('‚ùå Error: ' + result.error, 'error');
            }
        }

        function filterOrders() {
            const status = document.getElementById('order-status-filter').value;
            const search = document.getElementById('order-search').value.toLowerCase();
            
            let filtered = allOrders;
            if (status !== 'all') {
                filtered = filtered.filter(o => o.OrderStatus === status);
            }
            if (search) {
                filtered = filtered.filter(o => 
                    (o.OrderId || '').toLowerCase().includes(search) ||
                    (o.CustomerName || '').toLowerCase().includes(search)
                );
            }
            
            const tbody = document.getElementById('orders-table');
            tbody.innerHTML = filtered.length === 0 
                ? '<tr><td colspan="9" style="text-align:center;padding:30px;">No orders found</td></tr>'
                : filtered.map(o => `
                    <tr>
                        <td><strong>${o.OrderId || '-'}</strong></td>
                        <td>${o.CustomerName || '-'}</td>
                        <td>${o.CustomerPhone || '-'}</td>
                        <td>${o.items?.length || 0} items</td>
                        <td>‚Ç±${(o.Total || 0).toLocaleString()}</td>
                        <td>${o.PaymentMethod || '-'}</td>
                        <td><span class="badge ${getStatusClass(o.OrderStatus)}">${o.OrderStatus || 'Pending'}</span></td>
                        <td>${formatDate(o.CreatedAt)}</td>
                        <td><button class="btn btn-view btn-sm" onclick="viewOrder('${o.OrderId}')">View</button></td>
                    </tr>
                `).join('');
        }

        // ============ COMMISSIONS ============
        async function loadCommissions() {
            // Calculate from orders
            let totalCollected = 0;
            let totalPending = 0;
            
            allOrders.forEach(o => {
                const fee = o.PlatformFee || 0;
                if (o.OrderStatus === 'Completed' || o.OrderStatus === 'Delivered') {
                    totalCollected += fee;
                } else if (o.OrderStatus !== 'Cancelled') {
                    totalPending += fee;
                }
            });
            
            document.getElementById('comm-collected').textContent = '‚Ç±' + totalCollected.toLocaleString();
            document.getElementById('comm-pending').textContent = '‚Ç±' + totalPending.toLocaleString();
            
            const tbody = document.getElementById('commissions-table');
            const commissions = allOrders.filter(o => o.PlatformFee > 0);
            
            if (commissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;">No commissions yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = commissions.map(o => `
                <tr>
                    <td>COM-${o.OrderId?.slice(-8) || '-'}</td>
                    <td>${o.MerchantId || '-'}</td>
                    <td>${o.OrderId || '-'}</td>
                    <td>‚Ç±${(o.PlatformFee || 0).toLocaleString()}</td>
                    <td><span class="badge ${o.OrderStatus === 'Completed' || o.OrderStatus === 'Delivered' ? 'completed' : 'pending'}">
                        ${o.OrderStatus === 'Completed' || o.OrderStatus === 'Delivered' ? 'Collected' : 'Pending'}
                    </span></td>
                    <td>${formatDate(o.CreatedAt)}</td>
                    <td>-</td>
                </tr>
            `).join('');
        }

        // ============ USERS ============
        async function loadUsers() {
            // Note: Need to add getUsers to Apps Script
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#666;">User data loads from sheet directly</td></tr>';
        }

        // ============ PRODUCTS ============
        async function loadProducts() {
            const result = await fetchData('getProducts');
            if (result.success) {
                allProducts = result.data || [];
                renderProducts();
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('products-table');
            if (allProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;">No products yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = allProducts.map(p => `
                <tr>
                    <td>${p.ProductId || '-'}</td>
                    <td><strong>${p.Name || '-'}</strong></td>
                    <td>${p.MerchantId || '-'}</td>
                    <td>${p.Category || '-'}</td>
                    <td>‚Ç±${(p.Price || 0).toLocaleString()}</td>
                    <td>${p.available || 0}</td>
                    <td><span class="badge ${p.Status === 'Active' ? 'active' : 'pending'}">${p.Status || '-'}</span></td>
                </tr>
            `).join('');
        }

        // ============ STATS ============
        function updateStats() {
            document.getElementById('stat-merchants').textContent = allMerchants.length;
            document.getElementById('stat-orders').textContent = allOrders.length;
            document.getElementById('stat-users').textContent = allUsers.length || '-';
            
            const totalRevenue = allOrders
                .filter(o => o.OrderStatus !== 'Cancelled')
                .reduce((sum, o) => sum + (o.Total || 0), 0);
            document.getElementById('stat-revenue').textContent = '‚Ç±' + totalRevenue.toLocaleString();
            
            const totalCommission = allOrders
                .filter(o => o.OrderStatus === 'Completed' || o.OrderStatus === 'Delivered')
                .reduce((sum, o) => sum + (o.PlatformFee || 0), 0);
            document.getElementById('stat-commission').textContent = '‚Ç±' + totalCommission.toLocaleString();
        }

        // ============ HELPERS ============
        function formatDate(date) {
            if (!date) return '-';
            try {
                return new Date(date).toLocaleDateString('en-PH', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return date;
            }
        }

        function getStatusClass(status) {
            const map = {
                'Pending': 'pending',
                'Confirmed': 'processing',
                'Preparing': 'processing',
                'Out for Delivery': 'processing',
                'Delivered': 'completed',
                'Completed': 'completed',
                'Cancelled': 'cancelled',
                'Active': 'active'
            };
            return map[status] || 'pending';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });

        // Init
        checkAuth();
    </script>
</body>
</html>
