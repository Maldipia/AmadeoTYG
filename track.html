<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order - Amadeo Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 600px; }
        .track-card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 40px; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 28px; }
        .search-box { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .search-box input { padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        .search-box input:focus { outline: none; border-color: #667eea; }
        .search-box button { padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .search-box button:hover { transform: translateY(-2px); }
        .help-text { text-align: center; font-size: 12px; color: #666; margin-top: 10px; line-height: 1.6; }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { display: none; background: #fee; color: #c33; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .error-message.active { display: block; }
        .order-details { display: none; margin-top: 30px; }
        .order-details.active { display: block; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .order-id { font-size: 18px; font-weight: 600; color: #333; }
        .order-status { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-preparing { background: #d1ecf1; color: #0c5460; }
        .status-out_for_delivery { background: #cfe2ff; color: #084298; }
        .status-delivered { background: #d1e7dd; color: #0f5132; }
        .status-cancelled { background: #f8d7da; color: #842029; }
        .order-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-item { }
        .info-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .info-value { font-size: 16px; color: #333; font-weight: 500; }
        .order-items h3 { font-size: 18px; color: #333; margin-bottom: 15px; }
        .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="track-card">
            <h1><i class="fas fa-shipping-fast"></i> Track Your Order</h1>
            <div class="search-box">
                <input type="text" id="orderIdInput" placeholder="Enter Order ID (e.g., AMV-20251211-ABCD1234)">
                <input type="text" id="tokenInput" placeholder="Tracking Token (optional, for new orders)">
                <button onclick="trackOrder()"><i class="fas fa-search"></i> Track Order</button>
            </div>
            <p class="help-text">
                <strong>New orders:</strong> Use Order ID + Tracking Token<br>
                <strong>Old orders:</strong> Use Order ID only (phone verification required)
            </p>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Searching for your order...</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div class="order-details" id="orderDetails">
                <div class="order-header">
                    <div class="order-id" id="orderId"></div>
                    <div class="order-status" id="orderStatus"></div>
                </div>
                
                <div class="order-info">
                    <div class="info-item">
                        <div class="info-label">Order Date</div>
                        <div class="info-value" id="orderDate"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Amount</div>
                        <div class="info-value" id="orderTotal"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Customer</div>
                        <div class="info-value" id="orderCustomer"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Delivery Address</div>
                        <div class="info-value" id="orderAddress"></div>
                    </div>
                </div>
                
                <div class="order-items">
                    <h3>Order Items</h3>
                    <div id="orderItemsList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://script.google.com/macros/s/AKfycbxd8uHVq_G-xi9gEIk4EwNp-UVB8QaOlKGri8s_BN7dHCuUNOY00guX7knUXlpgzwtgCw/exec';
        
        function trackOrder() {
            const orderId = document.getElementById('orderIdInput').value.trim();
            
            if (!orderId) {
                showError('Please enter an order ID');
                return;
            }
            
            document.getElementById('loading').classList.add('active');
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('orderDetails').classList.remove('active');
            
            const token = document.getElementById('tokenInput').value.trim();
            
            if (token) {
                fetch(`${API_BASE}?action=trackOrder&orderId=${orderId}&token=${encodeURIComponent(token)}`)
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('loading').classList.remove('active');
                        if (data.success && data.order) {
                            displayOrder(data.order);
                        } else {
                            showError('Order not found. Please check your order ID and tracking token.');
                        }
                    })
                    .catch(err => {
                        document.getElementById('loading').classList.remove('active');
                        showError('Failed to track order. Please try again later.');
                    });
            } else {
                const phone = prompt('Please enter your phone number for verification:');
                if (!phone) {
                    document.getElementById('loading').classList.remove('active');
                    return;
                }
                
                fetch(`${API_BASE}?action=trackOrder&orderId=${orderId}&phone=${encodeURIComponent(phone)}`)
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('loading').classList.remove('active');
                        if (data.success && data.order) {
                            displayOrder(data.order);
                        } else {
                            showError('Order not found. Please check your order ID and phone number.');
                        }
                    })
                    .catch(err => {
                        document.getElementById('loading').classList.remove('active');
                        showError('Failed to track order. Please try again later.');
                    });
            }
        }
        
        function displayOrder(order) {
            document.getElementById('orderId').textContent = order.OrderId;
            document.getElementById('orderDate').textContent = new Date(order.CreatedAt).toLocaleDateString();
            document.getElementById('orderTotal').textContent = '₱' + parseFloat(order.Total || order.TotalAmount || 0).toFixed(2);
            document.getElementById('orderCustomer').textContent = order.CustomerName || 'N/A';
            document.getElementById('orderAddress').textContent = order.DeliveryAddress || 'N/A';
            
            const statusEl = document.getElementById('orderStatus');
            statusEl.textContent = (order.Status || 'pending').toUpperCase();
            statusEl.className = 'order-status status-' + (order.Status || 'pending').toLowerCase();
            
            const itemsList = document.getElementById('orderItemsList');
            itemsList.innerHTML = '';
            
            try {
                const items = typeof order.Items === 'string' ? JSON.parse(order.Items) : order.Items;
                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.innerHTML = `
                        <span>${item.name} x${item.quantity}</span>
                        <span>₱${parseFloat(item.price).toFixed(2)}</span>
                    `;
                    itemsList.appendChild(itemDiv);
                });
            } catch (e) {
                itemsList.innerHTML = '<p>Unable to load order items</p>';
            }
            
            document.getElementById('orderDetails').classList.add('active');
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }
        
        document.getElementById('orderIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') trackOrder();
        });
        document.getElementById('tokenInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') trackOrder();
        });
    </script>
</body>
</html>
