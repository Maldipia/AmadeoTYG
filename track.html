<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order - Amadeo Marketplace</title>
    <style>
        :root{--p:#0f766e;--pd:#134e4a;--pl:#14b8a6;--r:#ef4444;--g:#22c55e;--o:#f97316;--y:#eab308;--g1:#f9fafb;--g2:#e5e7eb;--g5:#6b7280;--g7:#374151;--g9:#111827;--sh:0 4px 6px -1px rgba(0,0,0,0.1);--rd:12px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--g1);color:var(--g9);line-height:1.5;min-height:100vh}
        
        .hdr{background:linear-gradient(135deg,var(--p),var(--pl));color:#fff;padding:14px 20px;position:sticky;top:0;z-index:100;box-shadow:var(--sh)}
        .hdr-in{max-width:800px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
        .logo{font-size:20px;font-weight:700}
        .logo a{color:#fff;text-decoration:none}
        .nav a{color:#fff;text-decoration:none;padding:8px 16px;border-radius:20px;font-size:14px}
        .nav a:hover{background:rgba(255,255,255,.2)}
        
        .container{max-width:800px;margin:0 auto;padding:30px 20px}
        
        .search-card{background:#fff;border-radius:var(--rd);box-shadow:var(--sh);padding:30px;margin-bottom:30px;text-align:center}
        .search-card h1{font-size:24px;color:var(--p);margin-bottom:8px}
        .search-card p{color:var(--g5);font-size:14px;margin-bottom:24px}
        .search-form{display:flex;gap:12px;max-width:450px;margin:0 auto}
        .search-form input{flex:1;padding:14px 18px;border:2px solid var(--g2);border-radius:10px;font-size:15px;transition:border-color .2s}
        .search-form input:focus{outline:none;border-color:var(--p)}
        .search-form button{padding:14px 28px;background:linear-gradient(135deg,var(--p),var(--pl));color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-size:15px}
        .search-form button:hover{opacity:.9}
        
        .result{display:none}
        .result.show{display:block}
        
        .order-card{background:#fff;border-radius:var(--rd);box-shadow:var(--sh);overflow:hidden;margin-bottom:24px}
        .order-header{background:linear-gradient(135deg,var(--p),var(--pl));color:#fff;padding:24px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:15px}
        .order-id{font-size:22px;font-weight:700}
        .order-date{font-size:13px;opacity:.9;margin-top:4px}
        .order-status{padding:10px 20px;background:#fff;color:var(--p);border-radius:25px;font-weight:700;font-size:14px}
        
        .order-body{padding:24px}
        
        .timeline{position:relative;padding-left:30px;margin-bottom:30px}
        .timeline::before{content:'';position:absolute;left:9px;top:0;bottom:0;width:2px;background:var(--g2)}
        .timeline-item{position:relative;padding-bottom:24px}
        .timeline-item:last-child{padding-bottom:0}
        .timeline-item::before{content:'';position:absolute;left:-21px;top:4px;width:20px;height:20px;background:#fff;border:2px solid var(--g2);border-radius:50%;z-index:1}
        .timeline-item.active::before{background:var(--p);border-color:var(--p)}
        .timeline-item.completed::before{background:var(--g);border-color:var(--g)}
        .timeline-item.completed::after{content:'‚úì';position:absolute;left:-17px;top:5px;color:#fff;font-size:12px;font-weight:bold;z-index:2}
        .timeline-title{font-weight:600;color:var(--g9);margin-bottom:2px}
        .timeline-time{font-size:13px;color:var(--g5)}
        
        .section-title{font-size:16px;font-weight:700;color:var(--g7);margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--g2)}
        
        .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:24px}
        .info-item{background:var(--g1);padding:16px;border-radius:10px}
        .info-label{font-size:12px;color:var(--g5);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
        .info-value{font-weight:600;color:var(--g9)}
        
        .items-list{margin-bottom:24px}
        .item-row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--g2)}
        .item-row:last-child{border-bottom:none}
        .item-name{font-weight:500}
        .item-qty{color:var(--g5);font-size:14px}
        .item-price{font-weight:600;color:var(--p)}
        
        .total-section{background:var(--g1);padding:16px;border-radius:10px}
        .total-row{display:flex;justify-content:space-between;margin-bottom:8px}
        .total-row:last-child{margin-bottom:0;padding-top:8px;border-top:2px solid var(--g2)}
        .total-row.grand{font-size:18px;font-weight:700;color:var(--p)}
        
        .not-found{text-align:center;padding:40px 20px}
        .not-found .icon{font-size:48px;margin-bottom:16px}
        .not-found h3{color:var(--g7);margin-bottom:8px}
        .not-found p{color:var(--g5)}
        
        .loading{text-align:center;padding:40px}
        .spinner{width:40px;height:40px;border:3px solid var(--g2);border-top-color:var(--p);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        .footer{text-align:center;padding:30px 20px;color:var(--g5);font-size:14px}
        .footer a{color:var(--p);text-decoration:none}
        
        @media(max-width:600px){
            .search-form{flex-direction:column}
            .order-header{flex-direction:column;text-align:center}
            .info-grid{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
    <header class="hdr">
        <div class="hdr-in">
            <div class="logo"><a href="/">üè™ Amadeo Marketplace</a></div>
            <nav class="nav"><a href="/">‚Üê Back to Shop</a></nav>
        </div>
    </header>

    <div class="container">
        <div class="search-card">
            <h1>üì¶ Track Your Order</h1>
            <p>Enter your order ID to see the current status</p>
            <form class="search-form" onsubmit="trackOrder(event)">
                <input type="text" id="orderId" placeholder="Enter Order ID (e.g., AMV-20241208-0001)" required>
                <button type="submit">Track</button>
            </form>
        </div>
        
        <div class="result" id="result"></div>
    </div>

    <footer class="footer">
        <p>Need help? <a href="tel:09669606060">Call us at 0966 960 6060</a></p>
        <p style="margin-top:8px">¬© 2025 Amadeo Marketplace. Powered by <a href="https://tyg-services.com" target="_blank">TYG Services</a></p>
    </footer>

    <script>
        var CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbwgHmmK1j8a6rqx_Zfk5nPGqdUIRSo1oIUNgGoVr2-in988F3K8Kyp8PN15zHS3InIUgw/exec'
        };

        function trackOrder(e) {
            e.preventDefault();
            var orderId = document.getElementById('orderId').value.trim();
            if (!orderId) return;
            
            var resultEl = document.getElementById('result');
            resultEl.innerHTML = '<div class="loading"><div class="spinner"></div><p>Looking up your order...</p></div>';
            resultEl.classList.add('show');
            
            fetch(CONFIG.API_URL + '?action=getOrder&orderId=' + encodeURIComponent(orderId))
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.success && data.data) {
                        displayOrder(data.data);
                    } else {
                        showNotFound();
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showNotFound();
                });
        }

        function displayOrder(order) {
            var statusSteps = ['pending', 'confirmed', 'preparing', 'out_for_delivery', 'delivered'];
            var currentIndex = statusSteps.indexOf(order.Status || 'pending');
            if (currentIndex === -1) currentIndex = 0;
            
            var items = parseItems(order.Items);
            var subtotal = parseFloat(order.Subtotal) || 0;
            var delivery = parseFloat(order.DeliveryFee) || 30;
            var total = parseFloat(order.Total) || (subtotal + delivery);
            
            var timelineHTML = '';
            var stepLabels = ['Order Placed', 'Confirmed', 'Preparing', 'Out for Delivery', 'Delivered'];
            
            for (var i = 0; i < statusSteps.length; i++) {
                var stepClass = '';
                if (i < currentIndex) {
                    stepClass = 'completed';
                } else if (i === currentIndex) {
                    stepClass = 'active';
                }
                timelineHTML += '<div class="timeline-item ' + stepClass + '">';
                timelineHTML += '<div class="timeline-title">' + stepLabels[i] + '</div>';
                if (i === currentIndex && order.UpdatedAt) {
                    timelineHTML += '<div class="timeline-time">' + formatDate(order.UpdatedAt) + '</div>';
                }
                timelineHTML += '</div>';
            }
            
            var itemsHTML = '';
            for (var j = 0; j < items.length; j++) {
                var item = items[j];
                var itemPrice = parseFloat(item.price) || 0;
                var itemQty = parseInt(item.quantity) || 1;
                itemsHTML += '<div class="item-row">';
                itemsHTML += '<div><span class="item-name">' + escapeHtml(item.name || 'Item') + '</span>';
                itemsHTML += '<span class="item-qty"> √ó ' + itemQty + '</span></div>';
                itemsHTML += '<span class="item-price">‚Ç±' + formatNumber(itemPrice * itemQty) + '</span>';
                itemsHTML += '</div>';
            }
            
            var html = '<div class="order-card">';
            html += '<div class="order-header">';
            html += '<div><div class="order-id">' + escapeHtml(order.OrderID || order.OrderId || 'N/A') + '</div>';
            html += '<div class="order-date">Placed on ' + formatDate(order.CreatedAt || order.Timestamp) + '</div></div>';
            html += '<div class="order-status">' + formatStatus(order.Status) + '</div>';
            html += '</div>';
            html += '<div class="order-body">';
            
            html += '<div class="section-title">Order Progress</div>';
            html += '<div class="timeline">' + timelineHTML + '</div>';
            
            html += '<div class="section-title">Delivery Details</div>';
            html += '<div class="info-grid">';
            html += '<div class="info-item"><div class="info-label">Customer</div><div class="info-value">' + escapeHtml(order.CustomerName || 'N/A') + '</div></div>';
            html += '<div class="info-item"><div class="info-label">Phone</div><div class="info-value">' + escapeHtml(order.Phone || 'N/A') + '</div></div>';
            html += '<div class="info-item"><div class="info-label">Address</div><div class="info-value">' + escapeHtml(order.Address || 'N/A') + '</div></div>';
            html += '<div class="info-item"><div class="info-label">Payment</div><div class="info-value">' + formatPayment(order.PaymentMethod) + '</div></div>';
            html += '</div>';
            
            html += '<div class="section-title">Order Items</div>';
            html += '<div class="items-list">' + itemsHTML + '</div>';
            
            html += '<div class="total-section">';
            html += '<div class="total-row"><span>Subtotal</span><span>‚Ç±' + formatNumber(subtotal) + '</span></div>';
            html += '<div class="total-row"><span>Delivery Fee</span><span>‚Ç±' + formatNumber(delivery) + '</span></div>';
            html += '<div class="total-row grand"><span>Total</span><span>‚Ç±' + formatNumber(total) + '</span></div>';
            html += '</div>';
            
            html += '</div></div>';
            
            document.getElementById('result').innerHTML = html;
            document.getElementById('result').classList.add('show');
        }

        function showNotFound() {
            var html = '<div class="order-card">';
            html += '<div class="not-found">';
            html += '<div class="icon">üîç</div>';
            html += '<h3>Order Not Found</h3>';
            html += '<p>We couldn\'t find an order with that ID. Please check and try again.</p>';
            html += '</div></div>';
            document.getElementById('result').innerHTML = html;
            document.getElementById('result').classList.add('show');
        }

        function parseItems(items) {
            if (!items) return [];
            if (Array.isArray(items)) return items;
            try {
                return JSON.parse(items);
            } catch (e) {
                return [];
            }
        }

        function formatStatus(s) {
            var statusMap = {
                'pending': '‚è≥ Pending',
                'confirmed': '‚úÖ Confirmed',
                'preparing': 'üë®‚Äçüç≥ Preparing',
                'out_for_delivery': 'üöö Out for Delivery',
                'delivered': '‚úÖ Delivered',
                'cancelled': '‚ùå Cancelled'
            };
            return statusMap[s] || s || 'Unknown';
        }

        function formatPayment(method) {
            var paymentMap = {
                'cod': 'Cash on Delivery',
                'COD': 'Cash on Delivery',
                'gcash': 'GCash',
                'GCash': 'GCash',
                'maya': 'Maya',
                'Maya': 'Maya',
                'bank': 'Bank Transfer'
            };
            return paymentMap[method] || method || 'N/A';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                var date = new Date(dateStr);
                return date.toLocaleDateString('en-PH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateStr;
            }
        }

        function formatNumber(num) {
            return parseFloat(num || 0).toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check URL for order ID
        document.addEventListener('DOMContentLoaded', function() {
            var urlParams = new URLSearchParams(window.location.search);
            var orderId = urlParams.get('id') || urlParams.get('order');
            if (orderId) {
                document.getElementById('orderId').value = orderId;
                trackOrder({ preventDefault: function() {} });
            }
        });
    </script>
</body>
</html>
