<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Login - Amadeo Marketplace</title>
    <style>
        :root{--p:#0f766e;--pd:#134e4a;--pl:#14b8a6;--r:#ef4444;--g:#22c55e;--o:#f97316;--g1:#f9fafb;--g2:#e5e7eb;--g5:#6b7280;--g7:#374151;--g9:#111827;--sh:0 4px 6px -1px rgba(0,0,0,0.1)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,var(--pd) 0%,var(--p) 50%,var(--pl) 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        
        .container{width:100%;max-width:480px}
        .logo{text-align:center;margin-bottom:30px}
        .logo a{color:#fff;text-decoration:none;font-size:28px;font-weight:700}
        .logo p{color:rgba(255,255,255,.8);font-size:14px;margin-top:8px}
        
        .card{background:#fff;border-radius:16px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);overflow:hidden}
        .card-header{padding:24px;text-align:center;border-bottom:1px solid var(--g2)}
        .card-header h1{font-size:22px;color:var(--g9);margin-bottom:4px}
        .card-header p{font-size:14px;color:var(--g5)}
        
        .card-body{padding:24px;max-height:75vh;overflow-y:auto}
        .tabs{display:flex;margin-bottom:24px;background:var(--g1);border-radius:8px;padding:4px}
        .tab{flex:1;padding:12px;border:none;background:none;cursor:pointer;font-weight:600;font-size:14px;color:var(--g5);border-radius:6px;transition:all .2s}
        .tab.active{background:#fff;color:var(--p);box-shadow:var(--sh)}
        
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:13px;font-weight:600;color:var(--g7);margin-bottom:6px}
        .form-group input,.form-group select{width:100%;padding:12px 14px;border:1px solid var(--g2);border-radius:8px;font-size:14px;transition:border-color .2s}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--p)}
        .form-group small{display:block;margin-top:4px;font-size:11px;color:var(--g5)}
        
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        @media(max-width:480px){.form-row{grid-template-columns:1fr}}
        
        .upload-box{border:2px dashed var(--g2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--g1)}
        .upload-box:hover{border-color:var(--p);background:#f0fdfa}
        .upload-box.has-file{border-color:var(--g);background:#dcfce7}
        .upload-box .icon{font-size:32px;margin-bottom:8px}
        .upload-box p{font-size:13px;color:var(--g5);margin-bottom:4px}
        .upload-box small{font-size:11px;color:var(--g5)}
        .upload-box input{display:none}
        .file-list{margin-top:10px;text-align:left}
        .file-item{display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:6px;margin-top:6px;font-size:12px}
        .file-item .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .file-item .remove{color:var(--r);cursor:pointer;padding:2px 6px}
        
        .btn{width:100%;padding:14px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s}
        .btn-primary{background:linear-gradient(135deg,var(--p),var(--pl));color:#fff}
        .btn-primary:hover{opacity:.9;transform:translateY(-1px)}
        .btn-primary:disabled{background:var(--g2);color:var(--g5);cursor:not-allowed;transform:none}
        
        .link{text-align:center;margin-top:20px}
        .link a{color:var(--p);text-decoration:none;font-size:14px;font-weight:500}
        .link a:hover{text-decoration:underline}
        
        .error{background:#fee2e2;color:#dc2626;padding:12px;border-radius:8px;margin-bottom:18px;font-size:13px;display:none}
        .success{background:#dcfce7;color:#16a34a;padding:12px;border-radius:8px;margin-bottom:18px;font-size:13px;display:none}
        
        .footer{text-align:center;margin-top:30px;color:rgba(255,255,255,.7);font-size:13px}
        .footer a{color:#fff}
        
        .section{display:none}
        .section.active{display:block}
        
        .benefits{margin-top:20px;padding-top:20px;border-top:1px solid var(--g2)}
        .benefits h4{font-size:13px;color:var(--g7);margin-bottom:12px}
        .benefits ul{list-style:none;font-size:13px;color:var(--g5)}
        .benefits li{padding:6px 0;display:flex;align-items:center;gap:8px}
        .benefits li::before{content:'‚úì';color:var(--g);font-weight:bold}
        
        .required-docs{background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px}
        .required-docs h5{color:#92400e;margin-bottom:6px;font-size:13px}
        .required-docs ul{margin-left:16px;color:#92400e}
        .required-docs li{margin-bottom:2px}
        
        .progress-bar{height:4px;background:var(--g2);border-radius:2px;margin-bottom:16px;overflow:hidden}
        .progress-fill{height:100%;background:var(--p);width:0%;transition:width .3s}
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <a href="/">üè™ Amadeo Marketplace</a>
            <p>Merchant Portal</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h1>Welcome, Seller!</h1>
                <p>Login or register to manage your store</p>
            </div>
            
            <div class="card-body">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('login')">Login</button>
                    <button class="tab" onclick="showTab('register')">Register</button>
                </div>
                
                <div id="error" class="error"></div>
                <div id="success" class="success"></div>
                
                <!-- LOGIN FORM -->
                <div id="login" class="section active">
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label>Phone Number or Email</label>
                            <input type="text" id="loginId" required placeholder="09XX XXX XXXX or email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Merchant ID (Optional)</label>
                            <input type="text" id="loginMerchant" placeholder="M-XXXXXX">
                            <small>Leave blank to find by phone/email</small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="loginBtn">Login to Dashboard</button>
                    </form>
                    
                    <div class="link">
                        <p style="color:var(--g5);font-size:13px;margin-bottom:8px">Don't have an account?</p>
                        <a href="#" onclick="showTab('register')">Register as Merchant ‚Üí</a>
                    </div>
                </div>
                
                <!-- REGISTER FORM -->
                <div id="register" class="section">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    
                    <form onsubmit="handleRegister(event)" id="registerForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Business Name *</label>
                                <input type="text" id="regBusiness" required placeholder="Your store name" onchange="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label>Owner Name *</label>
                                <input type="text" id="regOwner" required placeholder="Your full name" onchange="updateProgress()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone Number *</label>
                                <input type="tel" id="regPhone" required placeholder="09XX XXX XXXX" onchange="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="regEmail" placeholder="your@email.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Business Category *</label>
                                <select id="regCategory" required onchange="updateProgress()">
                                    <option value="">Select Category</option>
                                    <option>Food & Beverages</option>
                                    <option>Fresh Produce</option>
                                    <option>Groceries</option>
                                    <option>Health & Beauty</option>
                                    <option>Home & Living</option>
                                    <option>Fashion</option>
                                    <option>Services</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Barangay *</label>
                                <select id="regBrgy" required onchange="updateProgress()">
                                    <option value="">Select Barangay</option>
                                    <option>Barangay I (Poblacion)</option>
                                    <option>Barangay II (Poblacion)</option>
                                    <option>Barangay III (Poblacion)</option>
                                    <option>Dagatan</option>
                                    <option>Halang</option>
                                    <option>Maymangga</option>
                                    <option>Tibig</option>
                                    <option>Ulo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="required-docs">
                            <h5>üìã Required Documents</h5>
                            <ul>
                                <li>DTI / SEC / CDA Registration</li>
                                <li>Mayor's Permit / Barangay Clearance</li>
                                <li>Valid ID (Owner)</li>
                            </ul>
                        </div>
                        
                        <div class="form-group">
                            <label>Business Documents *</label>
                            <div class="upload-box" id="uploadBox" onclick="document.getElementById('regDocs').click()">
                                <div class="icon">üìÅ</div>
                                <p>Click to upload documents</p>
                                <small>DTI, Mayor's Permit, Valid ID (Max 5MB each)</small>
                                <input type="file" id="regDocs" multiple accept="image/*,.pdf" onchange="handleDocsUpload(this)">
                            </div>
                            <div class="file-list" id="fileList"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="regBtn">Create Merchant Account</button>
                    </form>
                    
                    <div class="benefits">
                        <h4>Why sell on Amadeo Marketplace?</h4>
                        <ul>
                            <li>Reach customers across all 24 barangays</li>
                            <li>0% commission on Cash on Delivery orders</li>
                            <li>Only 5% on online payments</li>
                            <li>Free merchant dashboard & analytics</li>
                            <li>Automated order notifications</li>
                        </ul>
                    </div>
                    
                    <div class="link">
                        <p style="color:var(--g5);font-size:13px;margin-bottom:8px">Already registered?</p>
                        <a href="#" onclick="showTab('login')">‚Üê Back to Login</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>¬© 2025 <a href="/">Amadeo Marketplace</a>. Powered by TYG Services.</p>
        </div>
    </div>
    
    <script>
    const API='https://script.google.com/macros/s/AKfycbxUmDgLqP1yV3XNmcXkB7D2ZoKgHdZI421hw7-nEZWlAWBmuHTAxMNN8-Ucw9C-yL5vnw/exec';
    let uploadedDocs = [];
    
    // Check if already logged in
    if(localStorage.getItem('amadeo_merchant')){
        window.location.href='/dashboard';
    }
    
    function showTab(tab){
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        event.target.classList.add('active');
        hideMessages();
    }
    
    function showError(msg){
        const el=document.getElementById('error');
        el.textContent=msg;
        el.style.display='block';
        document.getElementById('success').style.display='none';
    }
    
    function showSuccess(msg){
        const el=document.getElementById('success');
        el.textContent=msg;
        el.style.display='block';
        document.getElementById('error').style.display='none';
    }
    
    function hideMessages(){
        document.getElementById('error').style.display='none';
        document.getElementById('success').style.display='none';
    }
    
    function updateProgress(){
        const fields = ['regBusiness','regOwner','regPhone','regCategory','regBrgy'];
        let filled = 0;
        fields.forEach(id => {
            if(document.getElementById(id).value) filled++;
        });
        if(uploadedDocs.length > 0) filled++;
        const pct = Math.round((filled / 6) * 100);
        document.getElementById('progressFill').style.width = pct + '%';
    }
    
    function handleDocsUpload(input){
        const files = Array.from(input.files);
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        files.forEach(file => {
            if(file.size > maxSize){
                showError(`File "${file.name}" is too large. Max 5MB.`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = e => {
                uploadedDocs.push({
                    name: file.name,
                    type: file.type,
                    data: e.target.result
                });
                renderFileList();
                updateProgress();
            };
            reader.readAsDataURL(file);
        });
        
        // Update upload box style
        document.getElementById('uploadBox').classList.add('has-file');
    }
    
    function renderFileList(){
        const list = document.getElementById('fileList');
        list.innerHTML = uploadedDocs.map((f, i) => `
            <div class="file-item">
                <span>üìÑ</span>
                <span class="name">${f.name}</span>
                <span class="remove" onclick="removeDoc(${i})">‚úï</span>
            </div>
        `).join('');
    }
    
    function removeDoc(index){
        uploadedDocs.splice(index, 1);
        renderFileList();
        if(uploadedDocs.length === 0){
            document.getElementById('uploadBox').classList.remove('has-file');
        }
        updateProgress();
    }
    
    async function handleLogin(e){
        e.preventDefault();
        const btn=document.getElementById('loginBtn');
        btn.disabled=true;
        btn.textContent='Logging in...';
        hideMessages();
        
        const loginId=document.getElementById('loginId').value.trim();
        const merchantId=document.getElementById('loginMerchant').value.trim();
        
        try{
            // Fetch all merchants and find match
            const res=await fetch(`${API}?action=getMerchants`);
            const data=await res.json();
            
            if(!data.success)throw new Error('Unable to connect');
            
            const merchants=data.data||[];
            let merchant=null;
            
            if(merchantId){
                merchant=merchants.find(m=>m.MerchantId===merchantId);
            }
            
            if(!merchant){
                merchant=merchants.find(m=>
                    String(m.Phone||'')===loginId||
                    m.Email?.toLowerCase()===loginId.toLowerCase()||
                    String(m.Phone||'').replace(/\D/g,'')===loginId.replace(/\D/g,'')
                );
            }
            
            if(merchant){
                localStorage.setItem('amadeo_merchant',JSON.stringify(merchant));
                showSuccess('Login successful! Redirecting...');
                setTimeout(()=>window.location.href='/dashboard',1000);
            }else{
                showError('No merchant found with those credentials. Please register first.');
            }
        }catch(err){
            showError('Error: '+err.message);
        }finally{
            btn.disabled=false;
            btn.textContent='Login to Dashboard';
        }
    }
    
    async function handleRegister(e){
        e.preventDefault();
        
        // Validate documents
        if(uploadedDocs.length === 0){
            showError('Please upload at least one business document (DTI, Mayor\'s Permit, or Valid ID)');
            return;
        }
        
        const btn=document.getElementById('regBtn');
        btn.disabled=true;
        btn.textContent='Creating account...';
        hideMessages();
        
        const data={
            action:'registerMerchant',
            businessName:document.getElementById('regBusiness').value,
            ownerName:document.getElementById('regOwner').value,
            phone:document.getElementById('regPhone').value,
            email:document.getElementById('regEmail').value,
            category:document.getElementById('regCategory').value,
            barangay:document.getElementById('regBrgy').value,
            documents: uploadedDocs // Array of {name, type, data (base64)}
        };
        
        try{
            const res=await fetch(API,{
                method:'POST',
                mode:'cors',
                headers:{'Content-Type':'text/plain;charset=utf-8'},
                body:JSON.stringify(data)
            });
            const result=await res.json();
            
            if(result.success){
                const merchant={
                    MerchantId:result.merchantId,
                    BusinessName:data.businessName,
                    OwnerName:data.ownerName,
                    Phone:data.phone,
                    Email:data.email,
                    Category:data.category,
                    Barangay:data.barangay,
                    Status:'Pending',
                    CreatedAt:new Date().toISOString()
                };
                localStorage.setItem('amadeo_merchant',JSON.stringify(merchant));
                showSuccess(`Account created! Your Merchant ID: ${result.merchantId}\n\nYour documents are being reviewed. You'll be notified once approved.`);
                setTimeout(()=>window.location.href='/dashboard',3000);
            }else{
                throw new Error(result.error||'Registration failed');
            }
        }catch(err){
            showError('Error: '+err.message);
        }finally{
            btn.disabled=false;
            btn.textContent='Create Merchant Account';
        }
    }
    </script>
</body>
</html>
