<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amadeo Marketplace - API Test Dashboard</title>
  <style>
    :root {
      --primary: #2d5a27;
      --primary-light: #4a7c43;
      --secondary: #f4a020;
      --bg: #f5f5f5;
      --card: #ffffff;
      --text: #333333;
      --text-light: #666666;
      --success: #28a745;
      --error: #dc3545;
      --border: #e0e0e0;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 { font-size: 1.5rem; font-weight: 600; }
    .header .status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #666; }
    .status-dot.connected { background: var(--success); animation: pulse 2s infinite; }
    .status-dot.error { background: var(--error); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .api-config {
      background: var(--card);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .api-config label { font-weight: 600; display: block; margin-bottom: 0.5rem; }
    .api-config input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: monospace;
    }
    .api-config input:focus { outline: none; border-color: var(--primary); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .card h3 {
      font-size: 1rem;
      color: var(--text-light);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h3 .icon { font-size: 1.2rem; }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label { font-size: 0.85rem; color: var(--text-light); }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background: var(--primary-light); }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    .btn-secondary:hover { opacity: 0.9; }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover { background: var(--primary); color: white; }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .test-section {
      background: var(--card);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .test-section h3 {
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border);
    }

    .test-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .response-box {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.8rem;
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .response-box.success { border-left: 4px solid var(--success); }
    .response-box.error { border-left: 4px solid var(--error); }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .product-card {
      background: var(--bg);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .product-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      background: #ddd;
    }

    .product-card h4 {
      margin: 0.75rem 0 0.25rem;
      font-size: 0.9rem;
    }

    .product-card .price {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .product-card .price.sale {
      color: var(--error);
    }

    .product-card .original-price {
      text-decoration: line-through;
      color: var(--text-light);
      font-size: 0.8rem;
    }

    .product-card .stock {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
      margin-top: 0.5rem;
    }

    .stock.in_stock { background: #d4edda; color: #155724; }
    .stock.low { background: #fff3cd; color: #856404; }
    .stock.critical { background: #f8d7da; color: #721c24; }
    .stock.out { background: #e2e3e5; color: #383d41; }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-sale {
      background: var(--error);
      color: white;
    }

    .badge-closed {
      background: #6c757d;
      color: white;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .merchants-list {
      display: grid;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .merchant-item {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .merchant-item h4 { margin: 0 0 0.25rem; }
    .merchant-item .meta { font-size: 0.85rem; color: var(--text-light); }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      color: var(--text-light);
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .form-row { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 1rem; text-align: center; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸª Amadeo Marketplace - API Test Dashboard</h1>
    <div class="status">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Checking connection...</span>
    </div>
  </header>

  <div class="container">
    <!-- API Configuration -->
    <div class="api-config">
      <label for="apiUrl">ğŸ”— API Endpoint (Web App URL)</label>
      <input type="text" id="apiUrl" 
             value="https://script.google.com/macros/s/AKfycbwgHmmK1j8a6rqx_Zfk5nPGqdUIRSo1oIUNgGoVr2-in988F3K8Kyp8PN15zHS3InIUgw/exec"
             placeholder="Paste your deployed Web App URL here">
      <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-light);">
        âš ï¸ After deploying your Code.gs, paste the new Web App URL here and click "Test Connection"
      </p>
    </div>

    <!-- Quick Stats -->
    <div class="grid" id="statsGrid">
      <div class="card">
        <h3><span class="icon">ğŸª</span> Merchants</h3>
        <div class="stat-value" id="merchantCount">--</div>
        <div class="stat-label">Active Merchants</div>
      </div>
      <div class="card">
        <h3><span class="icon">ğŸ“¦</span> Products</h3>
        <div class="stat-value" id="productCount">--</div>
        <div class="stat-label">Total Products</div>
      </div>
      <div class="card">
        <h3><span class="icon">ğŸ”¥</span> On Sale</h3>
        <div class="stat-value" id="saleCount">--</div>
        <div class="stat-label">Flash Sales Active</div>
      </div>
      <div class="card">
        <h3><span class="icon">âš¡</span> API Status</h3>
        <div class="stat-value" id="apiVersion">--</div>
        <div class="stat-label" id="apiResponseTime">Response time: --</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="tests">ğŸ§ª API Tests</button>
      <button class="tab" data-tab="products">ğŸ“¦ Products</button>
      <button class="tab" data-tab="merchants">ğŸª Merchants</button>
      <button class="tab" data-tab="orders">ğŸ›’ Test Order</button>
    </div>

    <!-- Tab: API Tests -->
    <div class="tab-content active" id="tab-tests">
      <div class="test-section">
        <h3>ğŸ”Œ Connection Tests</h3>
        <div class="test-buttons">
          <button class="btn btn-primary" onclick="testHealthCheck()">â¤ï¸ Health Check</button>
          <button class="btn btn-outline" onclick="testGetMerchants()">ğŸª Get Merchants</button>
          <button class="btn btn-outline" onclick="testGetInventory()">ğŸ“¦ Get Inventory</button>
          <button class="btn btn-outline" onclick="testGetServices()">ğŸ”§ Get Services</button>
          <button class="btn btn-outline" onclick="testGetProperties()">ğŸ  Get Properties</button>
        </div>
        <div class="response-box" id="testResponse">
// API responses will appear here...
// Click a test button above to begin.
        </div>
      </div>

      <div class="test-section">
        <h3>ğŸ” Authentication Tests</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="merchant@example.com" value="legeryn@gmail.com">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Password" value="amadeo123">
          </div>
        </div>
        <div class="test-buttons">
          <button class="btn btn-primary" onclick="testMerchantLogin()">ğŸ”‘ Test Login</button>
          <button class="btn btn-outline" onclick="testGoogleLogin()">ğŸ”µ Test Google Login Flow</button>
        </div>
        <div class="response-box" id="authResponse">
// Authentication test results will appear here...
        </div>
      </div>
    </div>

    <!-- Tab: Products -->
    <div class="tab-content" id="tab-products">
      <div class="test-section">
        <h3>ğŸ“¦ Product Inventory</h3>
        <div class="test-buttons">
          <button class="btn btn-primary" onclick="loadProducts()">ğŸ”„ Refresh Products</button>
          <button class="btn btn-outline" onclick="filterProducts('all')">All</button>
          <button class="btn btn-outline" onclick="filterProducts('sale')">ğŸ”¥ On Sale</button>
          <button class="btn btn-outline" onclick="filterProducts('low')">âš ï¸ Low Stock</button>
        </div>
        <div class="products-grid" id="productsGrid">
          <p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">
            Click "Refresh Products" to load inventory
          </p>
        </div>
      </div>
    </div>

    <!-- Tab: Merchants -->
    <div class="tab-content" id="tab-merchants">
      <div class="test-section">
        <h3>ğŸª Registered Merchants</h3>
        <button class="btn btn-primary" onclick="loadMerchants()" style="margin-bottom: 1rem;">ğŸ”„ Refresh Merchants</button>
        <div class="merchants-list" id="merchantsList">
          <p style="text-align: center; color: var(--text-light);">
            Click "Refresh Merchants" to load list
          </p>
        </div>
      </div>
    </div>

    <!-- Tab: Test Order -->
    <div class="tab-content" id="tab-orders">
      <div class="test-section">
        <h3>ğŸ›’ Create Test Order</h3>
        <p style="margin-bottom: 1rem; color: var(--text-light);">
          Fill in the form below to create a test order and verify the full order flow.
        </p>
        
        <div class="form-row">
          <div class="form-group">
            <label>Customer Name *</label>
            <input type="text" id="orderName" placeholder="Juan Dela Cruz" value="Test Customer">
          </div>
          <div class="form-group">
            <label>Phone Number *</label>
            <input type="tel" id="orderPhone" placeholder="09XX XXX XXXX" value="09171234567">
          </div>
        </div>

        <div class="form-group">
          <label>Delivery Address</label>
          <input type="text" id="orderAddress" placeholder="123 Main St." value="Test Address, Amadeo">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Barangay</label>
            <select id="orderBarangay">
              <option value="Poblacion">Poblacion</option>
              <option value="Dagatan">Dagatan</option>
              <option value="Halang">Halang</option>
              <option value="Maymangga">Maymangga</option>
              <option value="Buho">Buho</option>
              <option value="Banaybanay">Banaybanay</option>
            </select>
          </div>
          <div class="form-group">
            <label>Payment Method</label>
            <select id="orderPayment">
              <option value="COD">Cash on Delivery (COD)</option>
              <option value="GCash">GCash</option>
              <option value="Maya">Maya</option>
              <option value="BankTransfer">Bank Transfer</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Order Items (JSON format)</label>
          <textarea id="orderItems" rows="4" placeholder='[{"productId": "P123", "merchantId": "M123", "quantity": 1, "price": 100}]'>[{"productId": "TEST001", "merchantId": "M1733656498498", "quantity": 2, "price": 150}]</textarea>
        </div>

        <div class="form-group">
          <label>Special Instructions</label>
          <input type="text" id="orderNotes" placeholder="Leave at guard house">
        </div>

        <button class="btn btn-secondary" onclick="createTestOrder()">ğŸ“ Create Test Order</button>
        
        <div class="response-box" id="orderResponse" style="margin-top: 1rem;">
// Order creation response will appear here...
        </div>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let API_URL = document.getElementById('apiUrl').value;
    let productsCache = [];

    document.getElementById('apiUrl').addEventListener('change', function() {
      API_URL = this.value;
      testHealthCheck();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
      });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API HELPER FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function apiGet(action, params = {}) {
      const url = new URL(API_URL);
      url.searchParams.set('action', action);
      Object.keys(params).forEach(key => {
        if (params[key]) url.searchParams.set(key, params[key]);
      });
      
      const startTime = Date.now();
      const response = await fetch(url.toString());
      const data = await response.json();
      data._responseTime = Date.now() - startTime;
      return data;
    }

    async function apiPost(action, payload = {}) {
      const startTime = Date.now();
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, ...payload })
      });
      const data = await response.json();
      data._responseTime = Date.now() - startTime;
      return data;
    }

    function showResponse(elementId, data, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = JSON.stringify(data, null, 2);
      el.className = 'response-box ' + (isError ? 'error' : 'success');
    }

    function updateStatus(connected, message) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      dot.className = 'status-dot ' + (connected ? 'connected' : 'error');
      text.textContent = message;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TEST FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function testHealthCheck() {
      try {
        showResponse('testResponse', { status: 'Testing connection...' });
        const data = await apiGet('healthCheck');
        
        if (data.success) {
          updateStatus(true, `Connected (v${data.version || '?'})`);
          document.getElementById('apiVersion').textContent = 'v' + (data.version || '?');
          document.getElementById('apiResponseTime').textContent = `Response: ${data._responseTime}ms`;
        } else {
          updateStatus(false, 'Connection failed');
        }
        
        showResponse('testResponse', data, !data.success);
        
        // Auto-load stats
        loadStats();
      } catch (error) {
        updateStatus(false, 'Connection error');
        showResponse('testResponse', { error: error.message }, true);
      }
    }

    async function testGetMerchants() {
      try {
        const data = await apiGet('getMerchants');
        showResponse('testResponse', data, !data.success);
      } catch (error) {
        showResponse('testResponse', { error: error.message }, true);
      }
    }

    async function testGetInventory() {
      try {
        const data = await apiGet('getAllInventory');
        showResponse('testResponse', data, !data.success);
      } catch (error) {
        showResponse('testResponse', { error: error.message }, true);
      }
    }

    async function testGetServices() {
      try {
        const data = await apiGet('getServices');
        showResponse('testResponse', data, !data.success);
      } catch (error) {
        showResponse('testResponse', { error: error.message }, true);
      }
    }

    async function testGetProperties() {
      try {
        const data = await apiGet('getProperties');
        showResponse('testResponse', data, !data.success);
      } catch (error) {
        showResponse('testResponse', { error: error.message }, true);
      }
    }

    async function testMerchantLogin() {
      try {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        const data = await apiPost('merchantLogin', { email, password });
        showResponse('authResponse', data, !data.success);
      } catch (error) {
        showResponse('authResponse', { error: error.message }, true);
      }
    }

    async function testGoogleLogin() {
      try {
        // Simulate Google login flow
        const data = await apiPost('googleLogin', {
          googleId: 'test_google_id_123',
          email: 'test@gmail.com',
          name: 'Test User'
        });
        showResponse('authResponse', data, !data.success);
      } catch (error) {
        showResponse('authResponse', { error: error.message }, true);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOAD DATA FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadStats() {
      try {
        const [merchants, inventory] = await Promise.all([
          apiGet('getMerchants'),
          apiGet('getAllInventory')
        ]);

        if (merchants.success) {
          document.getElementById('merchantCount').textContent = merchants.data.length;
        }

        if (inventory.success) {
          productsCache = inventory.data;
          document.getElementById('productCount').textContent = inventory.data.length;
          
          const onSale = inventory.data.filter(p => p.isOnSale);
          document.getElementById('saleCount').textContent = onSale.length;
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    async function loadProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">Loading...</p>';
      
      try {
        const data = await apiGet('getAllInventory');
        
        if (data.success && data.data.length > 0) {
          productsCache = data.data;
          renderProducts(productsCache);
        } else {
          grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">No products found. Add some products first!</p>';
        }
      } catch (error) {
        grid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--error);">Error: ${error.message}</p>`;
      }
    }

    function renderProducts(products) {
      const grid = document.getElementById('productsGrid');
      
      if (products.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">No products match filter</p>';
        return;
      }

      grid.innerHTML = products.map(p => `
        <div class="product-card">
          <img src="${p.ImageUrl || 'https://via.placeholder.com/200x120?text=No+Image'}" 
               alt="${p.Name}" 
               onerror="this.src='https://via.placeholder.com/200x120?text=No+Image'">
          ${p.isOnSale ? '<span class="badge badge-sale">ğŸ”¥ SALE</span>' : ''}
          ${p.isStoreOpen === false ? '<span class="badge badge-closed">Store Closed</span>' : ''}
          <h4>${p.Name}</h4>
          <p style="font-size: 0.8rem; color: var(--text-light);">${p.merchantName || p.MerchantId}</p>
          ${p.isOnSale 
            ? `<p class="original-price">â‚±${p.originalPrice}</p><p class="price sale">â‚±${p.currentPrice} (-${p.discountPercent}%)</p>`
            : `<p class="price">â‚±${p.currentPrice || p.Price}</p>`
          }
          <span class="stock ${p.stockStatus}">${p.available} available</span>
        </div>
      `).join('');
    }

    function filterProducts(filter) {
      let filtered = productsCache;
      
      if (filter === 'sale') {
        filtered = productsCache.filter(p => p.isOnSale);
      } else if (filter === 'low') {
        filtered = productsCache.filter(p => p.stockStatus === 'low' || p.stockStatus === 'critical' || p.stockStatus === 'out');
      }
      
      renderProducts(filtered);
    }

    async function loadMerchants() {
      const list = document.getElementById('merchantsList');
      list.innerHTML = '<p style="text-align: center;">Loading...</p>';
      
      try {
        const data = await apiGet('getMerchants');
        
        if (data.success && data.data.length > 0) {
          list.innerHTML = data.data.map(m => `
            <div class="merchant-item">
              <div>
                <h4>${m.BusinessName}</h4>
                <p class="meta">${m.Category || 'General'} â€¢ ${m.Barangay || 'Amadeo'}</p>
                <p class="meta">ğŸ“ ${m.Phone} ${m.IsOpen === 'TRUE' ? 'ğŸŸ¢ Open' : 'ğŸ”´ Closed'}</p>
              </div>
              <div style="text-align: right;">
                <p style="font-size: 0.8rem; color: var(--text-light);">ID: ${m.MerchantId}</p>
                <span class="badge" style="background: var(--success); color: white;">${m.Status}</span>
              </div>
            </div>
          `).join('');
        } else {
          list.innerHTML = '<p style="text-align: center; color: var(--text-light);">No merchants found</p>';
        }
      } catch (error) {
        list.innerHTML = `<p style="text-align: center; color: var(--error);">Error: ${error.message}</p>`;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ORDER CREATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function createTestOrder() {
      const responseBox = document.getElementById('orderResponse');
      responseBox.textContent = 'Creating order...';
      responseBox.className = 'response-box';
      
      try {
        let items;
        try {
          items = JSON.parse(document.getElementById('orderItems').value);
        } catch (e) {
          throw new Error('Invalid JSON in Order Items field');
        }

        const orderData = {
          customerName: document.getElementById('orderName').value,
          customerPhone: document.getElementById('orderPhone').value,
          deliveryAddress: document.getElementById('orderAddress').value,
          barangay: document.getElementById('orderBarangay').value,
          paymentMethod: document.getElementById('orderPayment').value,
          specialInstructions: document.getElementById('orderNotes').value,
          items: items,
          deliveryFee: 0
        };

        const data = await apiPost('createOrder', orderData);
        showResponse('orderResponse', data, !data.success);
        
        if (data.success) {
          alert(`âœ… Order Created!\n\nOrder ID: ${data.orderId}\nTotal: â‚±${data.total}`);
        }
      } catch (error) {
        showResponse('orderResponse', { error: error.message }, true);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Auto-test connection on load
    window.addEventListener('load', function() {
      setTimeout(testHealthCheck, 500);
    });
  </script>
</body>
</html>
