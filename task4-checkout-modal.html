<!-- ============================================================
     AMADEO MARKETPLACE v3.1 - TASK 4
     Checkout Modal with Buyer-Booked Courier Flow
============================================================ -->

<!-- CHECKOUT MODAL HTML - Add inside your index.html <body> -->
<div id="checkoutModal" class="modal">
    <div class="modal-content checkout-modal">
        <button class="modal-close" onclick="closeCheckout()">&times;</button>
        
        <div class="checkout-header">
            <h2>üõí Checkout</h2>
        </div>
        
        <div class="checkout-body">
            <!-- Order Summary -->
            <div class="co-section">
                <h3>üì¶ Order Summary</h3>
                <div id="coItems" class="co-items"></div>
                <div class="co-totals">
                    <div class="co-row"><span>Subtotal</span><span id="coSubtotal">‚Ç±0</span></div>
                    <div class="co-row"><span>Delivery Fee</span><span id="coDeliveryFee">‚Ç±0</span></div>
                    <div class="co-row co-grand"><span>Total</span><span id="coTotal">‚Ç±0</span></div>
                </div>
            </div>
            
            <!-- Customer Info -->
            <div class="co-section">
                <h3>üë§ Your Information</h3>
                <div class="co-form">
                    <div class="co-form-row">
                        <div class="co-field">
                            <label>Full Name *</label>
                            <input type="text" id="coName" placeholder="Juan Dela Cruz" required>
                        </div>
                        <div class="co-field">
                            <label>Phone *</label>
                            <input type="tel" id="coPhone" placeholder="09XX XXX XXXX" required>
                        </div>
                    </div>
                    <div class="co-field">
                        <label>Email (Optional)</label>
                        <input type="email" id="coEmail" placeholder="your@email.com">
                    </div>
                </div>
            </div>
            
            <!-- TASK 4 LOGIC 2 & 3: Fulfillment Section -->
            <!-- For PRODUCTS: Show Pickup vs Courier Toggle -->
            <div class="co-section" id="productFulfillmentSection">
                <h3>üöö How will you get your order?</h3>
                
                <div class="co-fulfillment-options">
                    <label class="co-fulfill-opt">
                        <input type="radio" name="fulfillment" value="pickup" checked onchange="handleFulfillmentChange()">
                        <div class="co-opt-card">
                            <span class="co-opt-icon">üè™</span>
                            <div class="co-opt-text">
                                <strong>Self Pickup</strong>
                                <small>Pick up at merchant's store</small>
                            </div>
                            <span class="co-opt-free">FREE</span>
                        </div>
                    </label>
                    
                    <label class="co-fulfill-opt">
                        <input type="radio" name="fulfillment" value="courier" onchange="handleFulfillmentChange()">
                        <div class="co-opt-card">
                            <span class="co-opt-icon">üèçÔ∏è</span>
                            <div class="co-opt-text">
                                <strong>Book My Own Courier</strong>
                                <small>Maxim, Lalamove, Tricycle</small>
                            </div>
                            <span class="co-opt-free">FREE</span>
                        </div>
                    </label>
                </div>
                
                <!-- TASK 4 LOGIC 4: Courier Warning -->
                <div id="courierWarning" class="co-warning" style="display:none;">
                    <div class="co-warning-icon">‚ö†Ô∏è</div>
                    <div class="co-warning-content">
                        <strong>You are responsible for booking the rider.</strong>
                        <p>Book via Maxim, Lalamove, Grab, or local tricycle. Merchant details will be shown after confirmation.</p>
                        <p class="co-warning-note">üí∞ Pay the rider directly.</p>
                    </div>
                </div>
            </div>
            
            <!-- For SERVICES: Show Date/Time Picker (TASK 4 LOGIC 3) -->
            <div class="co-section" id="serviceFulfillmentSection" style="display:none;">
                <h3>üìÖ Schedule Your Service</h3>
                <div class="co-service-booking">
                    <div class="co-form-row">
                        <div class="co-field">
                            <label>Preferred Date *</label>
                            <input type="date" id="serviceDate" required>
                        </div>
                        <div class="co-field">
                            <label>Preferred Time *</label>
                            <select id="serviceTime" required>
                                <option value="">Select time...</option>
                                <option value="08:00 AM">8:00 AM</option>
                                <option value="09:00 AM">9:00 AM</option>
                                <option value="10:00 AM">10:00 AM</option>
                                <option value="11:00 AM">11:00 AM</option>
                                <option value="12:00 PM">12:00 PM</option>
                                <option value="01:00 PM">1:00 PM</option>
                                <option value="02:00 PM">2:00 PM</option>
                                <option value="03:00 PM">3:00 PM</option>
                                <option value="04:00 PM">4:00 PM</option>
                                <option value="05:00 PM">5:00 PM</option>
                                <option value="06:00 PM">6:00 PM</option>
                            </select>
                        </div>
                    </div>
                    <div class="co-field">
                        <label>Service Address *</label>
                        <input type="text" id="serviceAddress" placeholder="Where should the service provider go?">
                    </div>
                    <div class="co-service-note">
                        <span>üìç</span> The service provider will come to your location.
                    </div>
                </div>
            </div>
            
            <!-- Delivery Address (for courier) -->
            <div class="co-section" id="addressSection" style="display:none;">
                <h3>üìç Your Address (for rider)</h3>
                <div class="co-form">
                    <div class="co-field">
                        <label>Barangay *</label>
                        <select id="coBarangay" required>
                            <option value="">Select Barangay...</option>
                            <optgroup label="Poblacion (Urban)">
                                <option value="Barangay I (Poblacion)">Barangay I (Poblacion)</option>
                                <option value="Barangay II (Poblacion)">Barangay II (Poblacion)</option>
                                <option value="Barangay III (Poblacion)">Barangay III (Poblacion)</option>
                                <option value="Barangay IV (Poblacion)">Barangay IV (Poblacion)</option>
                                <option value="Barangay V (Poblacion)">Barangay V (Poblacion)</option>
                                <option value="Barangay VI (Poblacion)">Barangay VI (Poblacion)</option>
                                <option value="Barangay VII (Poblacion)">Barangay VII (Poblacion)</option>
                                <option value="Barangay VIII (Poblacion)">Barangay VIII (Poblacion)</option>
                                <option value="Barangay IX (Poblacion)">Barangay IX (Poblacion)</option>
                                <option value="Barangay X (Poblacion)">Barangay X (Poblacion)</option>
                                <option value="Barangay XI (Poblacion)">Barangay XI (Poblacion)</option>
                                <option value="Barangay XII (Poblacion)">Barangay XII (Poblacion)</option>
                            </optgroup>
                            <optgroup label="Rural Barangays">
                                <option value="Banaybanay">Banaybanay</option>
                                <option value="Bucal">Bucal</option>
                                <option value="Buho">Buho</option>
                                <option value="Dagatan">Dagatan</option>
                                <option value="Halang">Halang</option>
                                <option value="Loma">Loma</option>
                                <option value="Maitim I">Maitim I</option>
                                <option value="Maymangga">Maymangga</option>
                                <option value="Minantok Kanluran">Minantok Kanluran</option>
                                <option value="Minantok Silangan">Minantok Silangan</option>
                                <option value="Pangil">Pangil</option>
                                <option value="Salaban">Salaban</option>
                                <option value="Talon">Talon</option>
                                <option value="Tamacan">Tamacan</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="co-field">
                        <label>Complete Address *</label>
                        <input type="text" id="coAddress" placeholder="House #, Street, Landmark">
                    </div>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="co-section">
                <h3>üí≥ Payment Method</h3>
                <div class="co-payment-options">
                    <label class="co-pay-opt">
                        <input type="radio" name="payment" value="cod" checked onchange="handlePaymentChange()">
                        <div class="co-pay-card"><span>üíµ</span><span>Cash</span></div>
                    </label>
                    <label class="co-pay-opt">
                        <input type="radio" name="payment" value="gcash" onchange="handlePaymentChange()">
                        <div class="co-pay-card"><span>üì±</span><span>GCash</span></div>
                    </label>
                    <label class="co-pay-opt">
                        <input type="radio" name="payment" value="maya" onchange="handlePaymentChange()">
                        <div class="co-pay-card"><span>üí≥</span><span>Maya</span></div>
                    </label>
                    <label class="co-pay-opt">
                        <input type="radio" name="payment" value="bank" onchange="handlePaymentChange()">
                        <div class="co-pay-card"><span>üè¶</span><span>Bank</span></div>
                    </label>
                </div>
                
                <!-- Online Payment Box -->
                <div id="onlinePaymentBox" class="co-online-pay" style="display:none;">
                    <div class="co-ref-box">
                        <small>Order Reference</small>
                        <strong id="coOrderRef">AMV-XXXXXXXX-XXXX</strong>
                    </div>
                    <div class="co-qr-row">
                        <img id="coQR" src="" alt="QR Code" class="co-qr">
                        <div class="co-account">
                            <strong id="coAccountName">TYG Services</strong>
                            <span id="coAccountNum">0966 960 6060</span>
                        </div>
                    </div>
                    <p class="co-pay-note">After payment, upload screenshot:</p>
                    <div class="co-upload">
                        <input type="file" id="coScreenshot" accept="image/*" onchange="previewScreenshot(this)">
                        <label for="coScreenshot">üì∑ Upload Screenshot</label>
                        <div id="coPreview"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Place Order Button -->
        <div class="checkout-footer">
            <button id="coPlaceBtn" class="co-place-btn" onclick="placeOrder()">
                üõí Place Order ‚Ä¢ <span id="coBtnTotal">‚Ç±0</span>
            </button>
        </div>
    </div>
</div>

<!-- ORDER SUCCESS MODAL -->
<div id="orderSuccessModal" class="modal">
    <div class="modal-content success-modal">
        <div class="success-header">
            <div class="success-icon">‚úÖ</div>
            <h2>Order Placed!</h2>
            <p>Order: <strong id="successOrderId">AMV-XXXXXXXX-XXXX</strong></p>
        </div>
        
        <div class="success-body">
            <!-- Merchant Pickup Info -->
            <div id="pickupInfo" class="pickup-box">
                <h3 id="pickupTitle">üì¶ Pick up your order at:</h3>
                <div class="merchant-card">
                    <div class="merchant-name" id="successMerchantName">Merchant Name</div>
                    <div class="merchant-detail">
                        <span>üìç</span>
                        <span id="successMerchantAddress">Address</span>
                    </div>
                    <div class="merchant-detail">
                        <span>üìû</span>
                        <a href="#" id="successMerchantPhone">Phone</a>
                    </div>
                    <div class="merchant-detail" id="pickupInstructionsRow" style="display:none;">
                        <span>üìù</span>
                        <span id="successPickupInstructions">Instructions</span>
                    </div>
                </div>
                
                <div id="courierReminder" class="courier-reminder" style="display:none;">
                    <strong>üèçÔ∏è Book your rider now!</strong>
                    <p>Use Maxim, Lalamove, Grab, or local tricycle.</p>
                </div>
            </div>
            
            <!-- Service Confirmation -->
            <div id="serviceInfo" class="service-confirm" style="display:none;">
                <h3>üìÖ Service Scheduled</h3>
                <div class="schedule-box">
                    <div class="schedule-date" id="successScheduleDate">December 8, 2025</div>
                    <div class="schedule-time" id="successScheduleTime">10:00 AM</div>
                </div>
                <p>The provider will contact you to confirm.</p>
            </div>
            
            <!-- Order Summary -->
            <div class="success-summary">
                <div class="summary-row"><span>Total:</span><strong id="successTotal">‚Ç±0</strong></div>
                <div class="summary-row"><span>Payment:</span><span id="successPayment">Cash</span></div>
            </div>
        </div>
        
        <div class="success-footer">
            <a href="track.html" class="btn-track">üìç Track Order</a>
            <button onclick="closeSuccessModal()" class="btn-done">Done</button>
        </div>
    </div>
</div>


<!-- ============================================================
     CHECKOUT CSS STYLES
============================================================ -->
<style>
/* Modal Base */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    padding: 20px;
    overflow-y: auto;
}
.modal.active { display: flex; justify-content: center; align-items: flex-start; }

.modal-content {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 500px;
    margin: 20px auto;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    position: relative;
}

.modal-close {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    z-index: 10;
}

/* Checkout Modal */
.checkout-header {
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: white;
    padding: 20px;
    text-align: center;
}
.checkout-header h2 { margin: 0; font-size: 22px; }

.checkout-body { padding: 0; max-height: 60vh; overflow-y: auto; }

.co-section {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
}
.co-section h3 { font-size: 14px; color: #111827; margin: 0 0 12px; }

/* Form */
.co-form { display: flex; flex-direction: column; gap: 12px; }
.co-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.co-field { display: flex; flex-direction: column; gap: 4px; }
.co-field label { font-size: 12px; font-weight: 600; color: #374151; }
.co-field input, .co-field select {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
}
.co-field input:focus, .co-field select:focus {
    outline: none;
    border-color: #14b8a6;
    box-shadow: 0 0 0 3px rgba(20,184,166,0.1);
}

/* Items & Totals */
.co-items { max-height: 120px; overflow-y: auto; }
.co-item { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px dashed #e5e7eb; }
.co-totals { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; }
.co-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
.co-row.co-grand { font-size: 16px; font-weight: 700; color: #0f766e; border-top: 2px solid #e5e7eb; margin-top: 8px; padding-top: 8px; }

/* Fulfillment Options */
.co-fulfillment-options { display: flex; flex-direction: column; gap: 10px; }
.co-fulfill-opt { cursor: pointer; }
.co-fulfill-opt input { display: none; }
.co-opt-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    transition: all 0.2s;
}
.co-fulfill-opt input:checked + .co-opt-card { border-color: #14b8a6; background: #f0fdfa; }
.co-opt-icon { font-size: 28px; }
.co-opt-text { flex: 1; }
.co-opt-text strong { display: block; font-size: 14px; color: #111827; }
.co-opt-text small { font-size: 11px; color: #6b7280; }
.co-opt-free { font-size: 12px; font-weight: 600; color: #22c55e; }

/* Courier Warning */
.co-warning {
    display: flex;
    gap: 12px;
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 10px;
    padding: 14px;
    margin-top: 12px;
}
.co-warning-icon { font-size: 24px; }
.co-warning-content strong { color: #92400e; font-size: 13px; }
.co-warning-content p { margin: 6px 0 0; font-size: 12px; color: #78350f; }
.co-warning-note { font-style: italic; }

/* Service Booking */
.co-service-booking { display: flex; flex-direction: column; gap: 12px; }
.co-service-note {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #eff6ff;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 12px;
    color: #1d4ed8;
}

/* Payment Options */
.co-payment-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.co-pay-opt { cursor: pointer; }
.co-pay-opt input { display: none; }
.co-pay-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 12px;
    transition: all 0.2s;
}
.co-pay-opt input:checked + .co-pay-card { border-color: #14b8a6; background: #f0fdfa; }
.co-pay-card span:first-child { font-size: 22px; margin-bottom: 4px; }

/* Online Payment Box */
.co-online-pay {
    background: #f9fafb;
    border-radius: 10px;
    padding: 16px;
    margin-top: 12px;
    text-align: center;
}
.co-ref-box {
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 12px;
}
.co-ref-box small { display: block; font-size: 11px; opacity: 0.9; }
.co-ref-box strong { font-size: 18px; letter-spacing: 1px; }
.co-qr-row { display: flex; align-items: center; justify-content: center; gap: 16px; margin: 12px 0; }
.co-qr { width: 100px; height: 100px; border-radius: 8px; border: 1px solid #e5e7eb; }
.co-account { text-align: left; }
.co-account strong { display: block; font-size: 14px; }
.co-account span { font-size: 16px; color: #0f766e; font-weight: 600; }
.co-pay-note { font-size: 12px; color: #6b7280; margin: 8px 0; }
.co-upload input { display: none; }
.co-upload label {
    display: inline-block;
    padding: 8px 16px;
    background: #14b8a6;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}
#coPreview { margin-top: 10px; }
#coPreview img { max-width: 150px; border-radius: 8px; border: 2px solid #14b8a6; }

/* Footer */
.checkout-footer { padding: 16px 20px; background: #f9fafb; }
.co-place-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.co-place-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(15,118,110,0.3); }
.co-place-btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }

/* Success Modal */
.success-modal { max-width: 420px; }
.success-header {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    padding: 30px 20px;
    text-align: center;
}
.success-icon { font-size: 48px; margin-bottom: 10px; }
.success-header h2 { margin: 0; font-size: 24px; }
.success-header p { margin: 8px 0 0; font-size: 14px; opacity: 0.95; }
.success-body { padding: 20px; }

.pickup-box {
    background: #f0fdfa;
    border: 1px solid #99f6e4;
    border-radius: 12px;
    padding: 16px;
    text-align: left;
}
.pickup-box h3 { font-size: 14px; margin: 0 0 12px; color: #0f766e; }
.merchant-card { background: white; border-radius: 8px; padding: 12px; }
.merchant-name { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 8px; }
.merchant-detail { display: flex; gap: 8px; font-size: 13px; color: #374151; margin: 4px 0; }
.merchant-detail a { color: #0f766e; font-weight: 600; text-decoration: none; }

.courier-reminder {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
    text-align: center;
}
.courier-reminder strong { color: #92400e; font-size: 14px; }
.courier-reminder p { margin: 4px 0 0; font-size: 12px; color: #78350f; }

.service-confirm {
    background: #eff6ff;
    border: 1px solid #3b82f6;
    border-radius: 12px;
    padding: 16px;
    text-align: center;
}
.service-confirm h3 { font-size: 14px; color: #1d4ed8; margin: 0 0 12px; }
.schedule-box { background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
.schedule-date { font-size: 16px; font-weight: 700; color: #111827; }
.schedule-time { font-size: 20px; font-weight: 700; color: #3b82f6; }
.service-confirm p { font-size: 12px; color: #1d4ed8; margin: 0; }

.success-summary { margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; }
.summary-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 14px; }

.success-footer { padding: 16px 20px; background: #f9fafb; display: flex; gap: 10px; }
.btn-track, .btn-done {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    text-align: center;
    border: none;
}
.btn-track { background: #0f766e; color: white; }
.btn-done { background: white; color: #374151; border: 1px solid #d1d5db; }

/* Responsive */
@media (max-width: 500px) {
    .co-form-row { grid-template-columns: 1fr; }
    .co-payment-options { grid-template-columns: repeat(2, 1fr); }
    .co-qr-row { flex-direction: column; }
}
</style>


<!-- ============================================================
     CHECKOUT JAVASCRIPT
============================================================ -->
<script>
const API = 'https://script.google.com/macros/s/AKfycbwgHmmK1j8a6rqx_Zfk5nPGqdUIRSo1oIUNgGoVr2-in988F3K8Kyp8PN15zHS3InIUgw/exec';

// Service categories that require scheduling
const SERVICE_CATEGORIES = ['Laundry', 'Massage', 'Cleaning', 'Beauty', 'Home Repair', 'Pet', 'Tutoring', 'Tech', 'Events', 'Automotive'];

// Checkout state
const checkout = {
    items: [],
    subtotal: 0,
    deliveryFee: 0, // TASK 4 LOGIC 1: ALWAYS ‚Ç±0
    total: 0,
    fulfillmentType: 'pickup',
    isService: false,
    merchantId: '',
    merchantName: '',
    merchantAddress: '',
    merchantPhone: '',
    pickupInstructions: '',
    orderId: '',
    screenshotData: ''
};

// Payment config
const PAYMENT_CONFIG = {
    gcash: { name: 'TYG Services', number: '0966 960 6060', qr: 'https://lh3.googleusercontent.com/d/YOUR_GCASH_QR' },
    maya: { name: 'TYG Services', number: '0966 960 6060', qr: 'https://lh3.googleusercontent.com/d/YOUR_MAYA_QR' },
    bank: { name: 'TYG Services - BDO', number: '0066 7890 1234', qr: 'https://lh3.googleusercontent.com/d/YOUR_BDO_QR' }
};


// ============================================================
// OPEN CHECKOUT
// ============================================================

function openCheckout() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
    }
    
    checkout.items = cart;
    const firstItem = cart[0];
    
    // TASK 4 LOGIC 3: Check if this is a service order
    checkout.isService = SERVICE_CATEGORIES.includes(firstItem.category || firstItem.Category);
    
    // Get merchant info
    checkout.merchantId = firstItem.merchantId || firstItem.MerchantId || '';
    checkout.merchantName = firstItem.merchantName || '';
    checkout.merchantAddress = firstItem.merchantFullAddress || firstItem.merchantAddress || '';
    checkout.merchantPhone = firstItem.merchantPhone || '';
    checkout.pickupInstructions = firstItem.pickupInstructions || '';
    
    // Calculate totals - TASK 4 LOGIC 1: Delivery Fee always ‚Ç±0
    checkout.subtotal = cart.reduce((sum, item) => {
        const price = item.displayPrice || item.price || item.Price || 0;
        return sum + (price * (item.quantity || 1));
    }, 0);
    checkout.deliveryFee = 0; // ALWAYS ‚Ç±0
    checkout.total = checkout.subtotal;
    
    // Generate order reference
    const now = new Date();
    checkout.orderId = `AMV-${now.toISOString().slice(0,10).replace(/-/g,'')}-${now.getTime().toString().slice(-4)}`;
    
    // Render items
    renderCheckoutItems();
    
    // TASK 4 LOGIC 2 & 3: Show/hide sections based on service vs product
    document.getElementById('productFulfillmentSection').style.display = checkout.isService ? 'none' : 'block';
    document.getElementById('serviceFulfillmentSection').style.display = checkout.isService ? 'block' : 'none';
    document.getElementById('addressSection').style.display = 'none';
    document.getElementById('courierWarning').style.display = 'none';
    
    // Set min date for service booking (tomorrow)
    if (checkout.isService) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('serviceDate').min = tomorrow.toISOString().slice(0, 10);
    }
    
    // Set order reference
    document.getElementById('coOrderRef').textContent = checkout.orderId;
    
    // Reset payment
    document.querySelector('input[name="payment"][value="cod"]').checked = true;
    document.getElementById('onlinePaymentBox').style.display = 'none';
    
    // Show modal
    document.getElementById('checkoutModal').classList.add('active');
}


// ============================================================
// RENDER ITEMS
// ============================================================

function renderCheckoutItems() {
    const itemsHtml = checkout.items.map(item => {
        const price = item.displayPrice || item.price || item.Price || 0;
        const qty = item.quantity || 1;
        return `
            <div class="co-item">
                <span>${qty}x ${item.name || item.Name}</span>
                <span>‚Ç±${(price * qty).toLocaleString()}</span>
            </div>
        `;
    }).join('');
    
    document.getElementById('coItems').innerHTML = itemsHtml;
    document.getElementById('coSubtotal').textContent = `‚Ç±${checkout.subtotal.toLocaleString()}`;
    document.getElementById('coDeliveryFee').textContent = '‚Ç±0'; // ALWAYS ‚Ç±0
    document.getElementById('coTotal').textContent = `‚Ç±${checkout.total.toLocaleString()}`;
    document.getElementById('coBtnTotal').textContent = `‚Ç±${checkout.total.toLocaleString()}`;
}


// ============================================================
// TASK 4 LOGIC 4: HANDLE FULFILLMENT CHANGE
// ============================================================

function handleFulfillmentChange() {
    const fulfillment = document.querySelector('input[name="fulfillment"]:checked').value;
    checkout.fulfillmentType = fulfillment;
    
    // Show/hide courier warning
    document.getElementById('courierWarning').style.display = fulfillment === 'courier' ? 'flex' : 'none';
    
    // Show/hide address section
    document.getElementById('addressSection').style.display = fulfillment === 'courier' ? 'block' : 'none';
    
    // TASK 4 LOGIC 1: Delivery fee is ALWAYS ‚Ç±0
    checkout.deliveryFee = 0;
    checkout.total = checkout.subtotal;
    
    document.getElementById('coDeliveryFee').textContent = '‚Ç±0';
    document.getElementById('coTotal').textContent = `‚Ç±${checkout.total.toLocaleString()}`;
    document.getElementById('coBtnTotal').textContent = `‚Ç±${checkout.total.toLocaleString()}`;
}


// ============================================================
// HANDLE PAYMENT CHANGE
// ============================================================

function handlePaymentChange() {
    const payment = document.querySelector('input[name="payment"]:checked').value;
    const box = document.getElementById('onlinePaymentBox');
    
    if (payment === 'cod') {
        box.style.display = 'none';
    } else {
        box.style.display = 'block';
        const config = PAYMENT_CONFIG[payment] || PAYMENT_CONFIG.gcash;
        document.getElementById('coQR').src = config.qr;
        document.getElementById('coAccountName').textContent = config.name;
        document.getElementById('coAccountNum').textContent = config.number;
    }
}


// ============================================================
// SCREENSHOT PREVIEW
// ============================================================

function previewScreenshot(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            checkout.screenshotData = e.target.result;
            document.getElementById('coPreview').innerHTML = `<img src="${e.target.result}" alt="Screenshot">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}


// ============================================================
// PLACE ORDER
// ============================================================

async function placeOrder() {
    const name = document.getElementById('coName').value.trim();
    const phone = document.getElementById('coPhone').value.trim();
    
    if (!name || !phone) {
        alert('Please fill in your name and phone number.');
        return;
    }
    
    if (!/^09\d{9}$/.test(phone.replace(/\s/g, ''))) {
        alert('Please enter a valid phone number (e.g., 09XX XXX XXXX)');
        return;
    }
    
    // Validate service booking
    if (checkout.isService) {
        const date = document.getElementById('serviceDate').value;
        const time = document.getElementById('serviceTime').value;
        const addr = document.getElementById('serviceAddress').value.trim();
        if (!date || !time || !addr) {
            alert('Please fill in date, time, and service address.');
            return;
        }
    }
    
    // Validate courier address
    if (checkout.fulfillmentType === 'courier') {
        const barangay = document.getElementById('coBarangay').value;
        const address = document.getElementById('coAddress').value.trim();
        if (!barangay || !address) {
            alert('Please fill in your address for the rider.');
            return;
        }
    }
    
    // Validate online payment screenshot
    const payment = document.querySelector('input[name="payment"]:checked').value;
    if (payment !== 'cod' && !checkout.screenshotData) {
        alert('Please upload your payment screenshot.');
        return;
    }
    
    const btn = document.getElementById('coPlaceBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Processing...';
    
    try {
        const orderData = {
            action: 'createOrder',
            orderId: checkout.orderId,
            merchantId: checkout.merchantId,
            customerName: name,
            customerPhone: phone.replace(/\s/g, ''),
            customerEmail: document.getElementById('coEmail').value.trim(),
            barangay: document.getElementById('coBarangay')?.value || '',
            deliveryAddress: document.getElementById('coAddress')?.value || '',
            items: checkout.items,
            subtotal: checkout.subtotal,
            deliveryFee: 0,
            platformFee: 0,
            total: checkout.total,
            paymentMethod: payment,
            paymentScreenshot: checkout.screenshotData,
            fulfillmentType: checkout.isService ? 'service' : checkout.fulfillmentType,
            scheduledTime: checkout.isService 
                ? `${document.getElementById('serviceDate').value} ${document.getElementById('serviceTime').value}`
                : ''
        };
        
        const response = await fetch(API, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            localStorage.removeItem('cart');
            if (typeof updateCartCount === 'function') updateCartCount();
            
            closeCheckout();
            showOrderSuccess(result);
        } else {
            throw new Error(result.error || 'Order failed');
        }
        
    } catch (error) {
        console.error('Order error:', error);
        alert('Failed to place order. Please try again.\n\n' + error.message);
        btn.disabled = false;
        btn.innerHTML = `üõí Place Order ‚Ä¢ <span id="coBtnTotal">‚Ç±${checkout.total.toLocaleString()}</span>`;
    }
}


// ============================================================
// SHOW ORDER SUCCESS
// ============================================================

function showOrderSuccess(result) {
    document.getElementById('successOrderId').textContent = result.orderId;
    
    const merchant = result.merchant || {
        name: checkout.merchantName,
        fullAddress: checkout.merchantAddress,
        phone: checkout.merchantPhone,
        pickupInstructions: checkout.pickupInstructions
    };
    
    document.getElementById('successMerchantName').textContent = merchant.name || 'Merchant';
    document.getElementById('successMerchantAddress').textContent = merchant.fullAddress || merchant.address || 'Contact merchant';
    
    const phoneEl = document.getElementById('successMerchantPhone');
    phoneEl.textContent = merchant.phone || 'N/A';
    phoneEl.href = merchant.phone ? `tel:${merchant.phone}` : '#';
    
    // Pickup instructions
    if (merchant.pickupInstructions) {
        document.getElementById('pickupInstructionsRow').style.display = 'flex';
        document.getElementById('successPickupInstructions').textContent = merchant.pickupInstructions;
    } else {
        document.getElementById('pickupInstructionsRow').style.display = 'none';
    }
    
    document.getElementById('successTotal').textContent = `‚Ç±${checkout.total.toLocaleString()}`;
    const paymentLabels = { cod: 'Cash on Pickup', gcash: 'GCash', maya: 'Maya', bank: 'Bank Transfer' };
    document.getElementById('successPayment').textContent = paymentLabels[document.querySelector('input[name="payment"]:checked').value];
    
    const pickupSection = document.getElementById('pickupInfo');
    const serviceSection = document.getElementById('serviceInfo');
    const courierReminder = document.getElementById('courierReminder');
    
    if (checkout.isService) {
        pickupSection.style.display = 'none';
        serviceSection.style.display = 'block';
        
        const parts = result.scheduledTime?.split(' ') || [];
        document.getElementById('successScheduleDate').textContent = parts[0] || '';
        document.getElementById('successScheduleTime').textContent = parts[1] || '';
    } else {
        pickupSection.style.display = 'block';
        serviceSection.style.display = 'none';
        
        if (checkout.fulfillmentType === 'courier') {
            document.getElementById('pickupTitle').textContent = 'üì¶ Book your rider to pick up at:';
            courierReminder.style.display = 'block';
        } else {
            document.getElementById('pickupTitle').textContent = 'üì¶ Pick up your order at:';
            courierReminder.style.display = 'none';
        }
    }
    
    document.getElementById('orderSuccessModal').classList.add('active');
}


// ============================================================
// CLOSE MODALS
// ============================================================

function closeCheckout() {
    document.getElementById('checkoutModal').classList.remove('active');
    document.getElementById('coName').value = '';
    document.getElementById('coPhone').value = '';
    document.getElementById('coEmail').value = '';
    document.getElementById('coPreview').innerHTML = '';
    checkout.screenshotData = '';
    
    const btn = document.getElementById('coPlaceBtn');
    btn.disabled = false;
    btn.innerHTML = `üõí Place Order ‚Ä¢ <span id="coBtnTotal">‚Ç±0</span>`;
}

function closeSuccessModal() {
    document.getElementById('orderSuccessModal').classList.remove('active');
}
</script>
